<!DOCTYPE html> 
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pusik Gifts - Full Feature</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/sdk@latest/dist/tonconnect-sdk.min.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

    <style>
        :root {
            --bg-gradient-start: #181A25; --bg-gradient-mid: #202333; --bg-gradient-end: #12141D;
            --surface-color: #282B3D; --surface-hover-color: #31354A;
            --primary-color: #007AFF; --primary-gradient-start: #007AFF; --primary-gradient-end: #34AADC;
            --secondary-color: #FF9500; --text-primary: #F5F5F7; --text-secondary: #AEB4C0;
            --text-placeholder: #7A7F8F; --text-price-color: #C7CDD6;
            --border-color: rgba(120, 120, 128, 0.25); --border-highlight: var(--primary-color);
            --danger-color: #FF3B30; --success-color: #30D158;
            --font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --main-border-radius: 16px; --button-border-radius: 12px;
            --soft-shadow: 0px 6px 20px rgba(0, 0, 0, 0.25);
            --case-grad-default: linear-gradient(145deg, var(--surface-color), var(--surface-hover-color));
            --roulette-item-height: 80px; /* Height of a single item in the roulette */
            --roulette-visible-items: 3; /* How many items are roughly visible */
            --single-roulette-row-visual-height: calc(var(--roulette-item-height) * var(--roulette-visible-items) + 20px); /* Total height for one reel to show N items + padding */
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { -webkit-overflow-scrolling: touch; }
        body { font-family: var(--font-family); background: linear-gradient(160deg, var(--bg-gradient-start) 0%, var(--bg-gradient-mid) 50%, var(--bg-gradient-end) 100%); color: var(--text-primary); overflow-x: hidden; display: flex; flex-direction: column; min-height: 100vh; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; -webkit-tap-highlight-color: transparent; font-weight: 500; font-size: 15px; line-height: 1.45; }
        #app-container { display: flex; flex-direction: column; flex-grow: 1; }
        #app-header { padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; background: linear-gradient(to right, rgba(30, 33, 50, 0.88), rgba(40, 43, 60, 0.92)); backdrop-filter: blur(18px) saturate(180%); -webkit-backdrop-filter: blur(18px) saturate(180%); border-bottom: 1px solid var(--border-color); box-shadow: 0 2px 12px rgba(0,0,0,0.2); }
        #app-header .app-title-container { display: flex; align-items: center; gap: 8px; }
        #app-header .app-logo { width: 32px; height: 32px; border-radius: 6px; }
        #app-header .app-title { font-size: 1.5em; font-weight: 700; color: var(--text-primary); letter-spacing: -0.5px; flex-shrink: 0; margin-right: 10px; }
        #app-header .wallet-info { display: flex; align-items: center; gap: 8px; flex-shrink: 1; min-width: 0; }
        #ton-connect-button { display: inline-block; flex-shrink: 0; }
        #wallet-address-display, #balance { background-color: var(--surface-hover-color); padding: 8px 12px; border-radius: var(--button-border-radius); font-size: 0.875em; font-weight: 600; border: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; display: none; transition: background-color 0.2s; }
        #wallet-address-display:hover, #balance:hover { background-color: var(--surface-color); }
        #wallet-address-display.connected, #balance.connected { display: block; }
        #balance.connected { display: flex; align-items: center; }
        #ton-connect-button.connected { display: none; }
        #app-content { flex-grow: 1; padding: 24px 18px; overflow-y: auto; padding-bottom: 80px; }
        .page { display: none; } .page.active { display: block; animation: pageFadeInMinimal 0.3s ease-out; }
        @keyframes pageFadeInMinimal { from { opacity: 0; transform: translateY(8px);} to { opacity: 1; transform: translateY(0px);} }
        #app-nav { display: flex; justify-content: space-around; align-items: stretch; background-color: rgba(28, 28, 30, 0.95); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); border-top: 1px solid var(--border-color); padding: 0; position: sticky; bottom: 0; z-index: 1000; min-height: 65px; box-shadow: 0 -3px 15px rgba(0,0,0,0.15); }
        .nav-button { background: none; border: none; color: var(--text-secondary); display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; font-weight: 500; cursor: pointer; padding: 8px 5px; border-radius: 0; transition: color 0.2s, background-color 0.2s, transform 0.1s ease-out; flex: 1; text-align: center; line-height: 1.3; }
        .nav-button:hover { background-color: rgba(255,255,255,0.05); } .nav-button:active { transform: scale(0.96); }
        .nav-button.active { color: var(--primary-color); font-weight: 600; }
        .nav-button svg { width: 28px; height: 28px; margin-bottom: 4px; fill: currentColor; }
        .nav-button.active svg { fill: var(--primary-color); }
        .button { background: linear-gradient(135deg, var(--primary-gradient-start), var(--primary-gradient-end)); color: var(--text-primary); border: none; padding: 14px 24px; border-radius: var(--button-border-radius); font-size: 1.0em; font-weight: 600; cursor: pointer; transition: filter 0.2s ease-out, transform 0.15s ease-out, box-shadow 0.2s ease-out; text-align: center; display: block; width: 100%; box-shadow: 0 3px 8px rgba(0,122,255,0.25); }
        .button:hover { filter: brightness(1.15); box-shadow: 0 4px 12px rgba(0,122,255,0.3); }
        .button:active { transform: scale(0.97); filter: brightness(0.9); box-shadow: 0 2px 5px rgba(0,122,255,0.2); }
        .button:disabled { background: var(--surface-hover-color); color: var(--text-placeholder); cursor: not-allowed; box-shadow: none; filter: grayscale(0.5); }
        .button-secondary { background-color: var(--surface-hover-color); color: var(--text-secondary); border: 1px solid var(--border-color); box-shadow: none; background-image: none; }
        .button-secondary:hover { background-color: var(--surface-color); color: var(--text-primary); border-color: rgba(120,120,128,0.5); }
        .button-secondary:active { background-color: var(--surface-hover-color); filter: brightness(0.9); }
        .button-secondary:disabled { background: var(--surface-color); color: var(--text-placeholder); border-color: var(--border-color); cursor: not-allowed; filter: grayscale(0.3); }
        h2 { margin-top: 0; font-size: 2.0em; font-weight: 700; color: var(--text-primary); padding-bottom: 10px; margin-bottom: 28px; letter-spacing: -0.5px; }
        h3 { font-size: 1.15em; font-weight: 600; color: var(--text-secondary); margin-top: 24px; margin-bottom: 14px; text-transform: uppercase; letter-spacing: 0.8px; }
        .content-card { background-color: var(--surface-color); padding: 20px; border-radius: var(--main-border-radius); margin-bottom: 20px; border: 1px solid var(--border-color); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .cases-grid, .slots-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(max(150px, calc(50% - 10px - 1px)), 1fr)); gap: 20px; }
        
        .case-card { background-image: var(--case-grad-default); border-radius: var(--main-border-radius); text-align: center; cursor: pointer; transition: all 0.2s ease; border: 1px solid var(--border-color); overflow: hidden; position: relative; display: flex; flex-direction: column; padding: 0; }
        .case-card:hover { filter: brightness(1.12); transform: translateY(-6px) scale(1.02); box-shadow: var(--soft-shadow); }
        .case-image-display { width: 100%; height: 0; padding-bottom: 100%; position: relative; background-color: var(--surface-hover-color); display:flex; align-items:center; justify-content:center; }
        .case-image-display img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; display: block; }
        .case-image-display .overlay-image { position: absolute; width: 70%; height: 70%; top: 50%; left: 50%; transform: translate(-50%, -50%); object-fit: contain; pointer-events: none; filter: drop-shadow(0 3px 5px rgba(0,0,0,0.35)); }
        .case-name { font-weight: 600; font-size: 1.05em; margin-bottom: 8px; color: var(--text-primary); min-height: 2.5em; display: flex; align-items: center; justify-content: center; }
        .case-card .case-name { display: none !important; }
        .case-price { font-size: 0.95em; font-weight: 600; color: var(--text-primary); padding: 12px 0; background-color: rgba(0,0,0,0.2); width: 100%; border-top: 1px solid var(--border-color); }
        
        .slot-card { background-image: var(--case-grad-default); border-radius: var(--main-border-radius); padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s ease; border: 1px solid var(--border-color); overflow: hidden; position: relative; }
        .slot-card:hover { filter: brightness(1.12); transform: translateY(-6px) scale(1.02); box-shadow: var(--soft-shadow); }
        .slot-image-display { width: 85px; height: 85px; margin: 0 auto 18px auto; background-color: transparent; border-radius: var(--button-border-radius); overflow: hidden; position: relative; display:flex; align-items:center; justify-content:center;}
        .slot-image-display img { display: block; width: 100%; height: 100%; object-fit: contain; }
        .slot-name { font-weight: 600; font-size: 1.05em; margin-bottom: 8px; color: var(--text-primary); min-height: 2.5em; display: flex; align-items: center; justify-content: center; }
        .slot-price { font-size: 0.9em; font-weight: 500; color: var(--text-price-color); }
        #profile-balance-display { font-size: 1.6em; font-weight: 600; color: var(--primary-color); margin-bottom: 20px; }
        
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(10, 10, 20, 0.75); backdrop-filter: blur(12px) saturate(150%); -webkit-backdrop-filter: blur(12px) saturate(150%); overflow-y: auto; align-items: flex-start; justify-content: center; padding-top: 5vh; padding-bottom: 5vh; }
        .modal.active { display: flex; animation: modalFadeInMinimal 0.3s ease-out; }
        .modal-content { background-color: var(--surface-color); padding: 28px; border-radius: var(--main-border-radius); width: 100%; max-width: 420px; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.4); border: 1px solid var(--border-color); display: flex; flex-direction: column; margin: auto; }
        .modal-content h3 { margin-top: 0; margin-bottom: 20px; font-size: 1.4em; font-weight: 700; color: var(--text-primary); flex-shrink: 0; }
        .modal-actions { margin-bottom: 18px; display: flex; flex-direction: column; gap: 14px; flex-shrink: 0; }
        .modal-body { overflow-y: auto; flex-grow: 1; -webkit-overflow-scrolling: touch; margin-top: 12px; max-height: 60vh; }
        
        #roulette-wheel-container { width: 100%; flex-shrink: 0; height: var(--single-roulette-row-visual-height); display: flex; gap: 8px; align-items: center; background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: var(--main-border-radius); overflow: hidden; position: relative; padding: 10px; }
        .roulette-individual-reel-row-visual { flex: 1; height: 100%; overflow: hidden; position: relative; background-color: var(--surface-hover-color); border-radius: var(--button-border-radius); border: 1px solid rgba(255,255,255,0.05); display: none; }
        .roulette-individual-reel-row-visual.active { display: block; }
        .roulette-individual-reel-row-visual::before { content: ''; position: absolute; left: 0; right: 0; top: 50%; height: 3px; background-color: var(--primary-color); opacity: 0.9; transform: translateY(-50%); z-index: 2; pointer-events: none; border-radius: 2px; }
        .roulette-spinner-reel { display: flex; flex-direction: column; position: absolute; left: 0; width: 100%; top: 0; }
        .roulette-item { height: var(--roulette-item-height); display: flex; align-items: center; justify-content: center; padding: 0 5px; box-sizing: border-box; overflow: hidden; transition: opacity 0.3s; }
        .roulette-item img { max-width: 90%; max-height: calc(var(--roulette-item-height) - 10px); object-fit: contain; }
        .case-multiplier-selector { display: flex; justify-content: center; gap: 10px; margin-top: 25px; margin-bottom: 15px; }
        .case-multiplier-selector button { width: auto; flex-grow: 1; padding: 10px 15px; font-size: 0.9em; }
        
        #win-overlay-modal .modal-content, #upgrade-result-modal .modal-content { max-width: 360px; }
        #win-overlay-prize-image, #upgrade-result-image-container { width: 100%; min-height: 80px; margin: 0 auto 20px; border-radius: var(--main-border-radius); background-color: var(--surface-hover-color); display:flex; align-items:center; justify-content:center; overflow:hidden; flex-wrap: wrap; gap: 10px; padding: 10px; }
        #win-overlay-prize-image img, #upgrade-result-image-container img { max-width:70px; max-height:70px; object-fit:contain; border-radius: 8px; background-color: var(--surface-color); padding: 5px; border: 1px solid var(--border-color); }
        #win-overlay-prize-name, #upgrade-result-title { font-size: 1.5em; font-weight: 700; margin-bottom: 8px; }
        #win-overlay-prize-name { color: var(--success-color); } /* Only for win overlay */
        #win-overlay-prize-details, #upgrade-result-message { font-size: 0.9em; color: var(--text-secondary); margin-bottom: 25px; max-height: 60px; overflow-y: auto; text-align: left; padding-left: 10px;}
        .win-overlay-actions button { margin-bottom: 10px; }
        
        #possible-prizes-display { padding-right: 0px; display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 12px; flex-shrink: 0; margin-top: 12px; }
        .prize-card { background-color: var(--surface-hover-color); border-radius: var(--button-border-radius); padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; border: 1px solid var(--border-color); text-align: center; min-height: 110px; }
        .prize-card-image-placeholder { width: 55px; height: 55px; background-color: transparent; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
        .prize-card-image-placeholder img { display: block; width: 100%; height: 100%; object-fit: contain; position: relative; z-index: 1; }
        .prize-card-name { font-size: 0.8em; font-weight: 500; color: var(--text-secondary); line-height: 1.25; width: 100%; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; white-space: normal; }
        .prize-card-price { position: absolute; top: 5px; right: 5px; background-color: var(--primary-color); color: var(--text-primary); font-size: 0.7em; font-weight: 600; padding: 2px 5px; border-radius: 5px; line-height: 1; }
        #roulette-modal hr { border: none; border-top: 1px solid var(--border-color); margin: 18px 0; flex-shrink: 0; }
        #roulette-modal h4 { font-size: 0.95em; color: var(--text-secondary); margin-bottom: 12px; font-weight: 500; flex-shrink: 0; }
        
        #slot-machine-modal .modal-content { max-width: 480px; }
        /* ... (existing slot styles, keep if slots feature is still there) ... */
        
        #withdraw-modal .modal-step { display: none; } #withdraw-modal .modal-step.active { display: block; } #withdraw-modal p { color: var(--text-secondary); margin-bottom: 18px; line-height: 1.55;} #withdraw-modal strong { color: var(--text-primary); font-weight: 600; } #withdraw-modal a.button { margin-bottom: 12px; text-decoration: none; }
        .loader { border: 4px solid var(--surface-hover-color); border-top: 4px solid var(--primary-color); border-radius: 50%; width: 45px; height: 45px; animation: spin 1s linear infinite; margin: 22px auto; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        input[type="text"], input[type="number"], select { width: 100%; padding: 13px 15px; margin-bottom: 14px; border-radius: var(--button-border-radius); background-color: var(--surface-hover-color); color: var(--text-primary); border: 1px solid var(--border-color); font-size: 1em; font-weight: 500; box-sizing: border-box; transition: border-color 0.2s, box-shadow 0.2s; } input[type="text"]::placeholder, input[type="number"]::placeholder { color: var(--text-placeholder); } input[type="text"]:focus, input[type="number"]:focus, select:focus { outline: none; border-color: var(--border-highlight); box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.25); }
        .profile-header { text-align: center; margin-bottom: 28px; padding-top: 12px;} .profile-avatar-placeholder { width: 88px; height: 88px; border-radius: 50%; background-color: var(--surface-hover-color); display: flex; align-items: center; justify-content: center; font-size: 2.8em; font-weight: 600; color: var(--text-secondary); margin: 0 auto 14px auto; border: 3px solid var(--border-color); box-shadow: 0 2px 6px rgba(0,0,0,0.1); } .profile-info .username { font-size: 1.5em; font-weight: 600; margin-bottom: 5px;} .profile-info .userid { font-size: 0.9em; color: var(--text-secondary); }
        #profile-wallet-address { display: block; text-align: left; word-break: break-all; margin-bottom: 10px; }
        .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(115px, 1fr)); gap: 12px; } .inventory-item { background-color: var(--surface-hover-color); border-radius: var(--button-border-radius); padding: 12px; text-align: center; display: flex; flex-direction: column; justify-content: space-between; border: 1px solid var(--border-color); transition: transform 0.2s, box-shadow 0.2s; } .inventory-item:hover { transform: translateY(-3px); box-shadow: 0 3px 10px rgba(0,0,0,0.15); } .inventory-item .item-image-display { width: 65px; height: 65px; margin: 0 auto 10px auto; background-color: transparent; border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center; position:relative; } .inventory-item .item-image-display img { display: block; width: 100%; height: 100%; object-fit: contain; position:relative; z-index: 1;}
        .inventory-item-name { font-size: 0.88em; font-weight: 500; margin-bottom: 5px; line-height: 1.35; } .inventory-item-value { font-size: 0.78em; color: var(--secondary-color); font-weight: 500; margin-bottom: 10px;} .inventory-item-actions { display: flex; flex-direction: column; gap: 6px; margin-top: auto; } .inventory-item-actions .button { font-size: 0.78em; padding: 6px 9px; margin: 0; width: 100%; }
        #sell-all-button { margin-top: 18px; background-color: var(--danger-color); color: white; background-image: none; box-shadow: 0 3px 8px rgba(255, 59, 48, 0.35); } #sell-all-button:hover { filter: brightness(1.15); background-color: var(--danger-color); box-shadow: 0 4px 12px rgba(255, 59, 48, 0.4); } #sell-all-button:active { filter: brightness(0.9); transform: scale(0.97); }
        
        /* --- NEW/UPDATED UPGRADE PAGE STYLES --- */
        #upgrade-selection-area {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 25px;
            gap: 10px; /* Gap between slots and arrow */
        }
        
        .upgrade-item-slot {
            flex: 1; /* Each slot takes equal width */
            max-width: calc(50% - 25px); /* Max width considering arrow and gap */
            height: 150px; /* Fixed height for the square */
            background-color: var(--surface-hover-color);
            border-radius: var(--main-border-radius);
            border: 2px dashed var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: border-color 0.2s, background-color 0.2s;
            padding: 10px;
            text-align: center;
        }
        .upgrade-item-slot:hover {
            border-color: var(--primary-color);
            background-color: var(--surface-color);
        }
        .upgrade-item-slot .slot-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-placeholder);
        }
        .upgrade-item-slot .slot-placeholder .plus-icon {
            width: 40px;
            height: 40px;
            margin-bottom: 8px;
            fill: var(--text-placeholder);
        }
        .upgrade-item-slot .slot-placeholder span {
            font-size: 0.9em;
            font-weight: 500;
        }
        .upgrade-item-slot .slot-item-display img {
            width: 60px; /* Adjust size as needed */
            height: 60px;
            object-fit: contain;
            margin-bottom: 8px;
            border-radius: 8px;
        }
        .upgrade-item-slot .slot-item-display .slot-item-name {
            font-size: 0.85em;
            font-weight: 500;
            color: var(--text-primary);
            line-height: 1.2;
            margin-bottom: 4px;
            max-height: 2.4em; /* Approx 2 lines */
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .upgrade-item-slot .slot-item-display .slot-item-value {
            font-size: 0.75em;
            font-weight: 600;
            color: var(--secondary-color);
        }
        
        .upgrade-arrow-connector {
            width: 30px; /* Width of the arrow */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .upgrade-arrow-connector svg {
            width: 28px;
            height: 28px;
            fill: var(--text-secondary);
        }
        
        #upgrade-picker-container {
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(0,0,0,0.1);
            border-radius: var(--button-border-radius);
        }
        #upgrade-picker-container h4 {
            color: var(--text-primary);
            font-size: 1.1em;
            margin-bottom: 15px;
            text-align: center;
        }
        /* Ensure inventory-grid within picker has proper styling */
        #upgrade-items-grid {
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); /* Adjust minmax for smaller cards */
            gap: 10px; /* Smaller gap */
            padding-right: 5px; /* For scrollbar space */
        }
        #upgrade-items-grid .inventory-item {
            padding: 10px; /* Smaller padding */
            min-height: 130px; /* Adjust height */
        }
        #upgrade-items-grid .inventory-item .item-image-display {
            width: 50px; height: 50px; margin-bottom: 8px;
        }
        #upgrade-items-grid .inventory-item .inventory-item-name { font-size: 0.8em; }
        #upgrade-items-grid .inventory-item .inventory-item-value { font-size: 0.7em; margin-bottom: 8px; }
        #upgrade-items-grid .inventory-item .button { font-size: 0.75em; padding: 5px 8px;}
        
        
        #upgrade-chance-display-container {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 30px auto; /* Increased margin for better spacing */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #upgrade-chance-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 8px solid var(--surface-hover-color); /* Default/Losing segment color */
            position: relative;
            /* Winning segment will be an overlay or conic-gradient if browser support is fine */
            background: conic-gradient(
                var(--success-color) 0deg var(--upgrade-win-segment-angle, 0deg), 
                var(--danger-color) var(--upgrade-win-segment-angle, 0deg) 360deg
            );
            box-shadow: 0 0 20px rgba(0,0,0,0.2), inset 0 0 15px rgba(0,0,0,0.3);
            transition: transform 0.3s ease-out; /* For subtle effects if needed */
        }
        
        #upgrade-chance-pointer {
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 18px solid var(--primary-color); /* Triangle color */
            position: absolute;
            top: -2px; /* Position slightly above the circle's border */
            left: 50%;
            transform: translateX(-50%) rotate(0deg); /* Initial position at the top */
            transform-origin: center calc(75px + 9px); /* (radius + half of triangle height approx offset from center) */
            z-index: 2;
            filter: drop-shadow(0px 2px 3px rgba(0,0,0,0.4));
        }
        #upgrade-chance-pointer.spinning {
            transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        
        
        #upgrade-chance-text-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: var(--text-primary);
            background-color: rgba(40, 43, 61, 0.85); /* Slightly transparent background for text */
            width: calc(100% - 32px); /* Inner circle for text, considering border width */
            height: calc(100% - 32px);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
        }
        #upgrade-calculated-multiplier {
            font-size: 2.2em;
            font-weight: 800;
            line-height: 1.1;
            color: var(--primary-gradient-end);
            display: block;
        }
        #upgrade-calculated-chance {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-secondary);
            display: block;
        }
        
        /* Old multiplier buttons removed from default view if any */
        #multiplier-buttons { display: none; } 
        #upgrade-inventory-select { display: none; }
        #upgrade-page .content-card p:first-of-type { display: none; } /* Hide "Select an item:" */
        #upgrade-page .content-card #upgrade-result { display: none; } /* Hide old result text */
        
        /* END UPGRADE PAGE STYLES */
        
        .stats-box { display: flex; justify-content: space-around; margin: 24px 0; gap: 14px; } .stat-item { background-color: var(--surface-hover-color); padding: 14px; border-radius: var(--button-border-radius); flex: 1; text-align: center; border: 1px solid var(--border-color); } .stat-item .value { font-size: 1.6em; font-weight: 600; color: var(--primary-color); } .stat-item .label { font-size: 0.8em; color: var(--text-secondary); margin-top: 5px; } .invited-users-list div { padding: 10px 0; border-bottom: 1px solid var(--border-color); font-size: 0.9em;} .invited-users-list div:last-child { border-bottom: none; }
        .leaderboard-list { padding-left: 0; padding-right: 0; } .leaderboard-list .leader-entry { display: flex; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border-color); transition: background-color 0.25s ease-out; position: relative; } .leaderboard-list .leader-entry:hover { background-color: rgba(255,255,255,0.04); } .leaderboard-list .leader-entry:last-child { border-bottom: none; } .leader-entry .rank { font-weight: 700; font-size: 1.05em; min-width: 40px; text-align: left; color: var(--text-secondary); margin-right: 15px; } .leader-entry .avatar-placeholder { width: 44px; height: 44px; border-radius: 50%; background-color: var(--surface-hover-color); color: var(--text-secondary); display: flex; align-items: center; justify-content: center; font-size: 1.2em; font-weight: 600; margin: 0 16px 0 0; border: 2px solid var(--border-color); } .leader-entry .info { flex-grow: 1; } .leader-entry .info .name { font-weight: 600; font-size: 1.1em; color: var(--text-primary); margin-bottom: 3px; } .leader-entry .info .details { font-size: 0.85em; color: var(--text-secondary); line-height: 1.3; } .leader-entry .score { margin-left: auto; font-weight: 700; font-size: 1.05em; color: var(--primary-color); padding-left: 15px; text-align: right; } .leader-entry.current-user-entry { background-color: rgba(0, 122, 255, 0.12); border-left: 3px solid var(--primary-color); padding-left: 17px;} .leader-entry.current-user-entry .rank { color: var(--primary-color); } .leader-entry.current-user-entry .info .name { color: var(--primary-gradient-end); font-weight: 700; } .leader-entry.current-user-entry .score { color: var(--secondary-color); font-weight: 800; } .leader-entry.current-user-entry .avatar-placeholder { border-color: var(--primary-color); }
        #deposit-instructions-modal .modal-body p { color: var(--text-secondary); font-size: 0.95em; line-height: 1.6; margin-bottom: 18px; } #deposit-instructions-modal .modal-body strong { color: var(--text-primary); font-weight: 600; } #deposit-instructions-modal #ton-transfer-link { margin-top: 10px; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 8px; } #deposit-instructions-modal #ton-transfer-link svg { width: 20px; height: 20px; fill: currentColor; } #deposit-status-message, #deposit-expiry-info { text-align: center; }
        .promocode-input-group { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; } .promocode-input-group input { flex-grow: 1; margin-bottom: 0; } .promocode-input-group button { flex-shrink: 0; padding: 13px 18px; width: auto; }
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(160deg, var(--bg-gradient-start) 0%, var(--bg-gradient-mid) 50%, var(--bg-gradient-end) 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: var(--text-primary); font-family: var(--font-family); transition: opacity 0.5s ease-out, visibility 0.5s ease-out; }
        #loading-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .loading-logo { width: 80px; height: 80px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .loading-title { font-size: 2.8em; font-weight: 800; margin-bottom: 30px; letter-spacing: -1px; background: linear-gradient(45deg, var(--primary-color), var(--primary-gradient-end)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 2px 8px rgba(0,122,255,0.2); }
        #loading-screen .loader { width: 60px; height: 60px; margin-top: 20px; margin-bottom: 30px; border-width: 6px; box-shadow: 0 0 15px rgba(0,122,255,0.2); }
        .loading-status-text { font-size: 1.1em; font-weight: 500; color: var(--text-secondary); margin-bottom: 40px; }
        .channel-link-container { position: absolute; bottom: 30px; width: 100%; text-align: center; }
        .channel-link-container a { color: var(--primary-color); text-decoration: none; font-weight: 600; font-size: 1.1em; padding: 8px 15px; border-radius: 8px; background-color: rgba(0,122,255,0.1); transition: background-color 0.2s, color 0.2s; }
        .channel-link-container a:hover { background-color: rgba(0,122,255,0.2); color: var(--text-primary); }
    </style>
</head>
<body>
    <div id="loading-screen">
        <img src="https://i.ibb.co/N6dt5Pc9/Background-Eraser-20250423-210102862.png" alt="Pusik Gifts Logo" class="loading-logo">
        <div class="loading-title">Pusik Gifts</div>
        <div class="loader"></div>
        <p id="loading-status" class="loading-status-text">Loading...</p>
        <div class="channel-link-container">
            <a href="https://t.me/pusikGifts" target="_blank">@pusikGifts</a>
        </div>
    </div>
    <div id="app-container">
        <header id="app-header">
            <div class="app-title-container"><img src="https://i.ibb.co/N6dt5Pc9/Background-Eraser-20250423-210102862.png" alt="Pusik Gifts Logo" class="app-logo"><div class="app-title">Pusik Gifts</div></div>
            <div class="wallet-info"><div id="wallet-address-display">Connected: ...</div><div id="balance"><span id="ton-balance">0.00</span> TON</div><div id="ton-connect-button"></div></div>
        </header>

        <main id="app-content">
            <div id="main-page" class="page active">
                <h2>Cases</h2>
                <div id="cases-grid" class="cases-grid"></div>
                <!-- Removed slots section for brevity, can be re-added if needed -->
            </div>

            <!-- UPGRADE PAGE - MODIFIED STRUCTURE -->
            <div id="upgrade-page" class="page">
                <h2>Upgrade Item</h2>
                <div class="content-card">
                    <div id="upgrade-selection-area">
                        <div class="upgrade-item-slot" id="selected-inventory-item-slot" data-type="inventory">
                            <div class="slot-placeholder">
                                <svg class="plus-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" /></svg>
                                <span>Your Item</span>
                            </div>
                            <div class="slot-item-display" style="display: none;">
                                <img src="" alt="Selected Item">
                                <p class="slot-item-name">Item Name</p>
                                <p class="slot-item-value">0.00 TON</p>
                            </div>
                        </div>
                        <div class="upgrade-arrow-connector">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4,15V9H12V4.16L19.84,12L12,19.84V15H4Z" /></svg>
                        </div>
                        <div class="upgrade-item-slot" id="desired-upgrade-item-slot" data-type="desired">
                            <div class="slot-placeholder">
                                <svg class="plus-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" /></svg>
                                <span>Desired Item</span>
                            </div>
                            <div class="slot-item-display" style="display: none;">
                                <img src="" alt="Desired Item">
                                <p class="slot-item-name">Item Name</p>
                                <p class="slot-item-value">0.00 TON</p>
                            </div>
                        </div>
                    </div>

                    <div id="upgrade-picker-container" style="display: none;">
                        <h4 id="upgrade-picker-title">Select Your Item</h4>
                        <div id="upgrade-items-grid" class="inventory-grid" style="max-height: 250px; overflow-y: auto; margin-bottom: 15px;">
                            <!-- Items will be populated here by JS -->
                        </div>
                        <button id="close-upgrade-picker-button" class="button button-secondary">Close Picker</button>
                    </div>
                    
                    <div id="upgrade-chance-display-container">
                        <div id="upgrade-chance-circle">
                            <div id="upgrade-chance-pointer"></div>
                        </div>
                        <div id="upgrade-chance-text-overlay">
                            <span id="upgrade-calculated-multiplier">--x</span>
                            <span id="upgrade-calculated-chance">--%</span>
                        </div>
                    </div>
                    
                    <button id="do-upgrade-button" class="button" disabled>Select Items to Upgrade</button>
                </div>
            </div>
            <!-- END UPGRADE PAGE -->

            <div id="invite-page" class="page"><h2>Referrals</h2><div class="content-card"><p>Invite friends & earn <strong>10%</strong> of deposits!</p><input type="text" id="referral-link" value="Loading..." readonly><button id="copy-ref-link-button" class="button">Copy Code</button><div class="stats-box"><div class="stat-item"><div id="referral-balance" class="value">0.00 TON</div><div class="label">Earnings</div></div><div class="stat-item"><div id="invited-count" class="value">0</div><div class="label">Invited</div></div></div><button id="withdraw-referral-button" class="button button-secondary">Withdraw</button></div><div class="content-card"><h3>Invited Friends</h3><div id="invited-users-list-display" class="invited-users-list"><p>No friends invited yet.</p></div></div></div>
            <div id="leaderboard-page" class="page"><h2>Leaderboard</h2><div id="leaderboard-list" class="leaderboard-list content-card" style="padding-top:0; padding-bottom:0;"></div></div>
            <div id="profile-page" class="page"><div class="profile-header"><div id="profile-avatar" class="profile-avatar-placeholder"></div><div class="profile-info"><div id="profile-username" class="username">User</div><div id="profile-userid" class="userid">#...</div></div></div><div class="content-card"><h3>Balance</h3><div id="profile-balance-display">0.00 TON</div><input type="number" id="deposit-amount-input" placeholder="Amount in TON"><button id="initiate-deposit-button" class="button">Deposit TON</button></div><div class="content-card"><h3>Promocode</h3><div class="promocode-input-group"><input type="text" id="promocode-input" placeholder="Enter code"><button id="redeem-promocode-button" class="button button-secondary">Redeem</button></div></div><div class="content-card"><h3>Wallet</h3><div id="profile-wallet-address">Not Connected</div><button id="disconnect-wallet-button" class="button button-secondary" style="display: none;">Disconnect</button></div><div class="content-card"><h3>My Collection (<span id="inventory-count">0</span>)</h3><div id="inventory-grid" class="inventory-grid"><p id="empty-inventory-message" style="grid-column: 1 / -1; text-align: center; color: var(--text-placeholder); padding:15px 0;">Your collection is empty.</p></div><button id="sell-all-button" class="button" style="display: none;">Sell All for <span id="sell-all-value">0.00</span> TON</button></div></div>
        </main>

        <nav id="app-nav">
            <button class="nav-button active" data-page="main-page"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>Games</button>
            <button class="nav-button" data-page="upgrade-page">
                <svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1">
                  <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
                  <path d="M7.41 11.41L12 6.83l4.59 4.58L18 10l-6-6-6 6z"/>
                  <path d="M7.41 7.41L12 2.83l4.59 4.58L18 6l-6-6-6 6z"/>
                </svg>Upgrade
            </button>
            <button class="nav-button" data-page="invite-page"><svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>Referrals</button>
            <button class="nav-button" data-page="leaderboard-page"><svg viewBox="0 0 24 24"><path d="M16,1H4C2.89,1 2,1.89 2,3V17H4V3H16V1M16.5,5H7.5C6.67,5 6,5.67 6,6.5V22.5L12,19.5L18,22.5V6.5C18,5.67 17.33,5 16.5,5M14,11H10V9H14V11M14,15H10V13H14V15Z"/></svg>Leaders</button>
            <button class="nav-button" data-page="profile-page"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>Profile</button>
        </nav>
    </div>

    <div id="roulette-modal" class="modal">
        <div class="modal-content">
            <h3 id="roulette-case-name">Opening Case...</h3>
            <div id="roulette-wheel-container">
                <div class="roulette-individual-reel-row-visual" id="roulette-reel-1">
                    <div class="roulette-spinner-reel"></div>
                </div>
                <div class="roulette-individual-reel-row-visual" id="roulette-reel-2">
                    <div class="roulette-spinner-reel"></div>
                </div>
                <div class="roulette-individual-reel-row-visual" id="roulette-reel-3">
                    <div class="roulette-spinner-reel"></div>
                </div>
            </div>
            <div class="case-multiplier-selector">
                <button class="button button-secondary active-multiplier" data-multiplier="1">1x</button>
                <button class="button button-secondary" data-multiplier="2">2x</button>
                <button class="button button-secondary" data-multiplier="3">3x</button>
            </div>
            <div class="modal-actions">
                <button id="spin-button" class="button">Spin</button>
                <button id="close-roulette-button" class="button button-secondary">Close</button>
            </div>
            <hr><h4>Possible Prizes in this Case:</h4><div id="possible-prizes-display"></div>
        </div>
    </div>

    <div id="win-overlay-modal" class="modal">
        <div class="modal-content">
            <div id="win-overlay-prize-image"></div>
            <div id="win-overlay-prize-name">You Won: Item!</div>
            <div id="win-overlay-prize-details"></div>
            <div class="win-overlay-actions modal-actions">
                <button id="win-overlay-save-button" class="button">Save to Collection</button>
                <button id="win-overlay-convert-button" class="button button-secondary">Convert All to <span id="win-overlay-convert-value">0.00</span> TON</button>
            </div>
        </div>
    </div>
    
    <!-- NEW UPGRADE RESULT MODAL -->
    <div id="upgrade-result-modal" class="modal">
        <div class="modal-content">
            <div id="upgrade-result-image-container">
                <!-- Image of item won/lost -->
            </div>
            <h3 id="upgrade-result-title">Upgrade Status</h3>
            <p id="upgrade-result-message">Details about the upgrade...</p>
            <div class="modal-actions">
                <button id="close-upgrade-result-modal-button" class="button">OK</button>
            </div>
        </div>
    </div>
    <!-- END UPGRADE RESULT MODAL -->


    <div id="withdraw-modal" class="modal">
        <div class="modal-content">
            <h3>Withdraw Gift</h3>
            <div class="modal-body">
                <div id="withdraw-step-1" class="modal-step active">
                    <p>To withdraw your NFT item, it will be sent as a gift via Tonnel Market.
                        <br><br><strong>IMPORTANT:</strong>
                        <br>1. Open Tonnel Gifts via the button below.
                        <br>2. You <strong>MUST</strong> send any message to the <a href="https://t.me/giftrelayer" target="_blank" style="color: var(--primary-color); text-decoration: underline;">@giftrelayer</a> bot in Telegram if you haven't interacted with it before. Otherwise, the gift cannot be delivered.
                    </p>
                    <a href="https://t.me/tonnel_network_bot/gifts?startapp=ref_5146625949" target="_blank" class="button" style="margin-bottom: 10px;">Open Tonnel Gifts & Message Relayer</a>
                    <button id="withdraw-step1-next" class="button button-secondary">Continue to Gift Selection</button>
                </div>

                <div id="withdraw-step-gifts" class="modal-step">
                    <p>Please choose the specific gift instance you wish to withdraw from the available listings on Tonnel Market. This may take a moment to load.</p>
                    <div id="tonnel-gift-choices-grid" class="inventory-grid" style="grid-template-columns: repeat(auto-fill, minmax(max(120px, calc(50% - 10px - 1px)), 1fr)); gap: 15px; margin-bottom: 20px; max-height: 35vh; overflow-y: auto; padding-top:10px;">
                        <div class="loader" id="tonnel-gifts-loader" style="display: none; grid-column: 1 / -1;"></div>
                    </div>
                    <button id="withdraw-step-gifts-confirm" class="button" style="display: none; margin-bottom:10px;">Confirm & Send Chosen Gift</button>
                    <button id="withdraw-step-gifts-back" class="button button-secondary">Back</button>
                </div>

                <div id="withdraw-step-finalizing" class="modal-step">
                     <p>Finalizing withdrawal for the chosen gift...</p>
                     <div id="withdraw-finalizing-loader" class="loader"></div>
                     <p id="withdraw-status-message"></p>
                     <button id="withdraw-step-finalizing-close" class="button button-secondary">Close</button>
                </div>
            </div>
            <button id="close-withdraw-modal-button" class="button button-secondary" style="margin-top:15px;">Close Window</button>
        </div>
    </div>

    <div id="deposit-instructions-modal" class="modal">
        <div class="modal-content">
            <h3>Deposit TON</h3>
            <div class="modal-body" style="text-align: left;">
                <p>To deposit TON, please send the exact amount specified to the address below. Ensure you include the unique comment if your wallet supports it, or send the precise nanoTON amount.</p>
                <a id="ton-transfer-link" href="#" target="_blank" class="button">
                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2zM12.012 6.5a1.023 1.023 0 00-.73.31l-3.204 3.272c-.203.207-.224.537-.04.763l1.715 2.11c.173.214.49.24.69.057l1.864-1.671a.525.525 0 01.742 0l1.864 1.67a.485.485 0 00.69-.057l1.715-2.11a.544.544 0 00-.04-.763L12.742 6.81a1.023 1.023 0 00-.73-.31zm-.001 1.447a.35.35 0 01.247.102l2.462 2.51-1.192 1.47-1.517-1.36a1.222 1.222 0 00-1.737-.001l-1.517 1.36-1.192-1.47 2.463-2.51a.35.35 0 01.247-.102zM8.5 14h7v1.5h-7z"/></svg>
                    Open Wallet & Pay
                </a>
                <p id="deposit-expiry-info"></p>
                <p id="deposit-status-message"></p>
                <div id="deposit-loader" class="loader" style="display:none;"></div>
                <button id="confirm-payment-sent-button" class="button button-secondary">I Sent Funds</button>
                <button id="cancel-deposit-button" class="button button-secondary">Cancel</button>
            </div>
        </div>
    </div>
<script>
// Global Constants and Data Definitions
const IMAGE_BASE_URL = 'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/GiftImages/';
const API_BASE_URL = 'https://case-hznb.onrender.com';
const BOT_USERNAME = 'pusikGiftsBot';
const MINI_APP_NAME = 'case';
const TON_COIN_FULL_URL = 'https://case-bot.com/images/actions/ton.svg';
const withdrawStep1NextBtn = document.getElementById('withdraw-step1-next');
const currentUser = {
    id: null, username: null, first_name: 'User', last_name: null,
    walletAddress: null, walletAddressRaw: null, tonBalance: 0.00, starBalance: 0,
    inventory: [], referralCode: null, referralEarningsPending: 0, total_won_ton: 0,
    invited_friends_count: 0,
    photo_url: null // Added field for user profile photo URL
};
let currentOpenCaseOrSlot = null;
let selectedCaseMultiplier = 1;
let itemToWithdraw = null;
const upgradeChances = { 1.5: 50, 2: 35, 3: 25, 5: 15, 10: 8, 20: 3 };
let lastWonPrizesForOverlay = [];
let selectedUpgradeMultiplier = 1.5;
let spinAnimationTimeoutOuter = null; // Initialize as null for safety

let selectedItemForUpgrade = null;    // { id, name, imageFilename, currentValue }
let desiredItemForUpgrade = null;     // { name, imageFilename, floorPrice }
let calculatedUpgradeMultiplier = 0;
let calculatedUpgradeChance = 0;
let currentUpgradePickerType = null; // 'inventory' or 'desired'
let allAppGiftsForUpgrade = []; // To be populated with all unique gifts
    
const GIFT_NAME_TO_ID_MAP = {
  "Santa Hat": "5983471780763796287","Signet Ring": "5936085638515261992","Precious Peach": "5933671725160989227","Plush Pepe": "5936013938331222567",
  "Spiced Wine": "5913442287462908725","Jelly Bunny": "5915502858152706668","Durov's Cap": "5915521180483191380","Perfume Bottle": "5913517067138499193",
  "Eternal Rose": "5882125812596999035","Berry Box": "5882252952218894938","Vintage Cigar": "5857140566201991735","Magic Potion": "5846226946928673709",
  "Kissed Frog": "5845776576658015084","Hex Pot": "5825801628657124140","Evil Eye": "5825480571261813595","Sharp Tongue": "5841689550203650524",
  "Trapped Heart": "5841391256135008713","Skull Flower": "5839038009193792264","Scared Cat": "5837059369300132790","Spy Agaric": "5821261908354794038",
  "Homemade Cake": "5783075783622787539","Genie Lamp": "5933531623327795414","Lunar Snake": "6028426950047957932","Party Sparkler": "6003643167683903930",
  "Jester Hat": "5933590374185435592","Witch Hat": "5821384757304362229","Hanging Star": "5915733223018594841","Love Candle": "5915550639663874519",
  "Cookie Heart": "6001538689543439169","Desk Calendar": "5782988952268964995","Jingle Bells": "6001473264306619020","Snow Mittens": "5980789805615678057",
  "Voodoo Doll": "5836780359634649414","Mad Pumpkin": "5841632504448025405","Hypno Lollipop": "5825895989088617224","B-Day Candle": "5782984811920491178",
  "Bunny Muffin": "5935936766358847989","Astral Shard": "5933629604416717361","Flying Broom": "5837063436634161765","Crystal Ball": "5841336413697606412",
  "Eternal Candle": "5821205665758053411","Swiss Watch": "5936043693864651359","Ginger Cookie": "5983484377902875708","Mini Oscar": "5879737836550226478",
  "Lol Pop": "5170594532177215681","Ion Gem": "5843762284240831056","Star Notepad": "5936017773737018241","Loot Bag": "5868659926187901653",
  "Love Potion": "5868348541058942091","Toy Bear": "5868220813026526561","Diamond Ring": "5868503709637411929","Sakura Flower": "5167939598143193218",
  "Sleigh Bell": "5981026247860290310","Top Hat": "5897593557492957738","Record Player": "5856973938650776169","Winter Wreath": "5983259145522906006",
  "Snow Globe": "5981132629905245483","Electric Skull": "5846192273657692751","Tama Gadget": "6023752243218481939","Candy Cane": "6003373314888696650",
  "Neko Helmet": "5933793770951673155","Jack-in-the-Box": "6005659564635063386","Easter Egg": "5773668482394620318",
  "Bonded Ring": "5870661333703197240", "Pet Snake": "6023917088358269866", "Snake Box": "6023679164349940429",
  "Xmas Stocking": "6003767644426076664", "Big Year": "6028283532500009446", "Gem Signet": "5859442703032386168",
  "Light Sword": "5897581235231785485"
};

// Add near global variables
let availableTonnelGifts = [];
let selectedTonnelGiftDetails = null; // To store { gift_id, gift_num, name, price } of chosen gift

// DOM Element References (Additions for withdrawal modal)
const tonnelGiftChoicesGrid = document.getElementById('tonnel-gift-choices-grid');
const tonnelGiftsLoader = document.getElementById('tonnel-gifts-loader');
const withdrawStepGiftsConfirmBtn = document.getElementById('withdraw-step-gifts-confirm');
const withdrawStepGiftsBackBtn = document.getElementById('withdraw-step-gifts-back');
const withdrawFinalizingLoader = document.getElementById('withdraw-finalizing-loader'); // New specific loader ID

// Update showWithdrawStep to handle the new structure
function showWithdrawStep(stepName) { // stepName will be 'step-1', 'step-gifts', 'step-finalizing'
    withdrawSteps.forEach(s => s.classList.remove('active'));
    const targetStep = document.getElementById(`withdraw-${stepName}`);
    if (targetStep) {
        targetStep.classList.add('active');
    } else {
        console.error(`Withdraw step with ID 'withdraw-${stepName}' not found.`);
    }
}

// Helper to format gift name for Fragment URL
function formatGiftNameForFragmentUrl(name) {
    if (!name) return 'unknown';
    let formatted = name.toLowerCase();
    formatted = formatted.replace(/&/g, 'and');
    formatted = formatted.replace(/'/g, '');
    formatted = formatted.replace(/\s+/g, ''); // Remove all spaces
    formatted = formatted.replace(/[^a-z0-9]/gi, ''); // Remove special characters except numbers
    return formatted;
}


// Modify startWithdrawalProcess
function startWithdrawalProcess(inventoryItemId) {
    const item = currentUser.inventory.find(i => i.id === parseInt(inventoryItemId));
    if (!item || item.is_ton_prize) {
        showTGNotification("Item not found or not withdrawable.", "error");
        return;
    }
    itemToWithdraw = inventoryItemId; // Store the inventory item ID
    selectedTonnelGiftDetails = null; // Reset selection
    availableTonnelGifts = []; // Reset available gifts

    withdrawModal.querySelector('h3').textContent = `Withdraw ${item.name}`;
    showWithdrawStep('step-1'); // Show initial instructions step
    withdrawModal.classList.add('active');
    if (tgBackButton) pushTgBackButtonHandler(closeWithdrawModal);
}

// NEW: Handle "Continue" from Step 1 - Fetch Tonnel Gifts
withdrawStep1NextBtn.addEventListener('click', async () => {
    if (!itemToWithdraw) {
        showTGNotification("Error: No item selected for withdrawal.", "error");
        return;
    }
    showWithdrawStep('step-gifts');
    tonnelGiftsLoader.style.display = 'block';
    tonnelGiftChoicesGrid.innerHTML = ''; // Clear previous choices
    withdrawStepGiftsConfirmBtn.style.display = 'none';

    try {
        // The itemToWithdraw (inventory_item_id) is already set
        const gifts = await apiRequest(`/api/tonnel_gift_listings/${itemToWithdraw}`);
        availableTonnelGifts = gifts; // Store the fetched gifts
        populateTonnelGiftChoicesGrid(gifts);
    } catch (error) {
        console.error("Failed to fetch Tonnel gift listings:", error);
        tonnelGiftChoicesGrid.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: var(--danger-color);">Could not load gift listings. Please try again.</p>`;
    } finally {
        tonnelGiftsLoader.style.display = 'none';
    }
});

// NEW: Populate Tonnel Gift Choices Grid
function populateTonnelGiftChoicesGrid(gifts) {
    tonnelGiftChoicesGrid.innerHTML = ''; // Clear existing
    if (!gifts || gifts.length === 0) {
        tonnelGiftChoicesGrid.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: var(--text-placeholder);">No listings found for this gift on Tonnel Market currently.</p>`;
        return;
    }

    gifts.forEach(gift => {
        const card = document.createElement('div');
        card.className = 'case-card inventory-item'; // Re-use similar styling
        card.style.cursor = 'pointer';
        card.style.padding = '10px'; // Add some padding
        card.dataset.giftId = gift.gift_id; // Tonnel's internal ID for purchase
        card.dataset.giftNum = gift.gift_num; // Tonnel's display number for Fragment URL
        card.dataset.giftName = gift.name;
        card.dataset.giftPrice = gift.price; // Store price for confirmation if needed

        const fragmentName = formatGiftNameForFragmentUrl(gift.name);
        const imageUrl = `https://nft.fragment.com/gift/${fragmentName}-${gift.gift_num}.webp`;
        
        const imgCont = document.createElement('div');
        imgCont.className = 'item-image-display'; // Reuse inventory item image display style
        imgCont.style.width = '65px'; imgCont.style.height = '65px'; // Adjust size as needed
        const img = document.createElement('img');
        img.src = imageUrl;
        img.alt = `${gift.name} #${gift.gift_num}`;
        img.loading = 'lazy';
        img.onerror = () => { img.src = generateImageFilename('placeholder.png'); }; // Fallback
        imgCont.appendChild(img);

        const nameEl = document.createElement('div');
        nameEl.className = 'inventory-item-name';
        nameEl.textContent = `${gift.name} #${gift.gift_num}`;
        nameEl.style.fontSize = '0.8em'; // Smaller text

        const priceEl = document.createElement('div'); // Displaying Tonnel price
        priceEl.className = 'inventory-item-value';
        priceEl.textContent = `${gift.price} TON`;
        priceEl.style.fontSize = '0.75em';

        card.appendChild(imgCont);
        card.appendChild(nameEl);
        card.appendChild(priceEl);

        card.addEventListener('click', () => handleTonnelGiftChoice(card, gift));
        tonnelGiftChoicesGrid.appendChild(card);
    });
}

// NEW: Handle Tonnel Gift Choice
function handleTonnelGiftChoice(selectedCard, giftData) {
    // Remove selection from other cards
    tonnelGiftChoicesGrid.querySelectorAll('.case-card').forEach(card => {
        card.style.border = '1px solid var(--border-color)'; // Reset border
    });
    // Highlight selected card
    selectedCard.style.border = '2px solid var(--primary-color)';
    
    selectedTonnelGiftDetails = {
        gift_id: giftData.gift_id, // This is crucial for purchase
        gift_num: giftData.gift_num,
        name: giftData.name,
        price: giftData.price // Store for confirmation
    };
    withdrawStepGiftsConfirmBtn.style.display = 'block';
    withdrawStepGiftsConfirmBtn.textContent = `Send ${giftData.name} #${giftData.gift_num} (${giftData.price} TON)`;
}

// Event listener for "Back" from gift selection
withdrawStepGiftsBackBtn.addEventListener('click', () => {
    showWithdrawStep('step-1');
    selectedTonnelGiftDetails = null; // Clear selection
    tonnelGiftChoicesGrid.innerHTML = ''; // Clear gift choices
    withdrawStepGiftsConfirmBtn.style.display = 'none';
});

// Event listener for "Confirm & Send Chosen Gift"
withdrawStepGiftsConfirmBtn.addEventListener('click', async () => {
    if (!selectedTonnelGiftDetails || !itemToWithdraw) {
        showTGNotification("Error: No gift selected or item issue.", "error");
        return;
    }
    await completeChosenGiftWithdrawal();
});
    
const UPDATED_FLOOR_PRICES_FRONTEND = {
    'Plush Pepe': 3024.0,       // Updated
    'Neko Helmet': 15.0,
    'Sharp Tongue': 17.0,
    "Durov's Cap": 420.0,       // Updated
    'Voodoo Doll': 9.4,
    'Vintage Cigar': 24.0,      // Updated
    'Astral Shard': 80.0,       // Updated
    'Scared Cat': 22.0,
    'Swiss Watch': 25.0,        // Updated
    'Perfume Bottle': 88.0,     // Updated
    'Precious Peach': 270.0,    // Updated
    'Toy Bear': 16.3,
    'Genie Lamp': 46.0,         // Updated
    'Loot Bag': 45.0,           // Updated
    'Kissed Frog': 24.0,        // Updated
    'Electric Skull': 10.9,
    'Diamond Ring': 12.0,       // Updated
    'Mini Oscar': 40.5,
    'Party Sparkler': 2.0,
    'Homemade Cake': 2.0,
    'Cookie Heart': 1.8,
    'Jack-in-the-box': 2.0,
    'Skull Flower': 3.4,
    'Lol Pop': 1.1,             // Updated
    'Hypno Lollipop': 1.4,      // Assuming this stays or update if related to Lol Pop
    'Desk Calendar': 1.1,       // Updated
    'B-Day Candle': 1.4,
    'Record Player': 4.0,
    'Jelly Bunny': 3.6,
    'Tama Gadget': 4.0,
    'Snow Globe': 2.0,          // Updated
    'Eternal Rose': 11.0,
    'Love Potion': 5.4,
    'Top Hat': 6.0,
    'Berry Box': 4.1,
    'Bunny Muffin': 4.0,
    'Candy Cane': 1.6,
    'Crystal Ball': 6.0,
    'Easter Egg': 1.8,
    'Eternal Candle': 3.1,
    'Evil Eye': 4.2,
    'Flying Broom': 4.5,
    'Ginger Cookie': 2.7,
    'Hanging Star': 4.1,
    'Hex Pot': 3.1,
    'Ion Gem': 44.0,
    'Jester Hat': 2.0,
    'Jingle Bells': 1.8,
    'Love Candle': 6.7,
    'Lunar Snake': 1.5,
    'Mad Pumpkin': 6.2,
    'Magic Potion': 54.0,       // Updated
    'Pet Snake': 3.2,
    'Sakura Flower': 4.1,
    'Santa Hat': 2.0,
    'Signet Ring': 18.8,
    'Sleigh Bell': 6.0,
    'Snow Mittens': 2.9,
    'Spiced Wine': 2.2,
    'Spy Agaric': 2.8,
    'Star Notepad': 2.8,
    'Trapped Heart': 6.0,
    'Winter Wreath': 2.0,
    "Big Year": 4.4,
    "Snake Box": 3.3,
    "Bonded Ring": 60.5,
    "Xmas Stocking": 2.5
    // Add Light Sword and Gem Signet if they have defined prices
    // "Light Sword": XX.X,
    // "Gem Signet": XX.X
};
const KISSED_FROG_VARIANT_FLOORS={"Happy Pepe":500.0,"Tree Frog":150.0,"Brewtoad":150.0,"Puddles":150.0,"Honeyhop":150.0,"Melty Butter":150.0,"Lucifrog":150.0,"Zodiak Croak":150.0,"Count Croakula":150.0,"Lilie Pond":150.0,"Sweet Dream":150.0,"Frogmaid":150.0,"Rocky Hopper":150.0,"Icefrog":45.0,"Lava Leap":45.0,"Toadstool":45.0,"Desert Frog":45.0,"Cupid":45.0,"Hopberry":45.0,"Ms. Toad":45.0,"Trixie":45.0,"Prince Ribbit":45.0,"Pond Fairy":45.0,"Boingo":45.0,"Tesla Frog":45.0,"Starry Night":30.0,"Silver":30.0,"Ectofrog":30.0,"Poison":30.0,"Minty Bloom":30.0,"Sarutoad":30.0,"Void Hopper":30.0,"Ramune":30.0,"Lemon Drop":30.0,"Ectobloom":30.0,"Duskhopper":30.0,"Bronze":30.0,"Lily Pond":19.0,"Toadberry":19.0,"Frogwave":19.0,"Melon":19.0,"Sky Leaper":19.0,"Frogtart":19.0,"Peach":19.0,"Sea Breeze":19.0,"Lemon Juice":19.0,"Cranberry":19.0,"Tide Pod":19.0,"Brownie":19.0,"Banana Pox":19.0};
Object.assign(UPDATED_FLOOR_PRICES_FRONTEND, KISSED_FROG_VARIANT_FLOORS);

function generateImageFilename(nameOrUrl) {
    if (!nameOrUrl) return IMAGE_BASE_URL + 'placeholder.png';
    if (nameOrUrl.startsWith('http://') || nameOrUrl.startsWith('https://')) return nameOrUrl;
    const name = nameOrUrl;
    if (name.toLowerCase().includes("ton") && name.toLowerCase().includes("prize")) return TON_COIN_FULL_URL;
    if (GIFT_NAME_TO_ID_MAP[name]) return `https://cdn.changes.tg/gifts/originals/${GIFT_NAME_TO_ID_MAP[name]}/Original.png`;
    if (Object.keys(KISSED_FROG_VARIANT_FLOORS).includes(name)) return `https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/${name.replace(/\s/g, '%20')}.png`;
    let filename = name.replace(/\s+/g, '-').replace(/&/g, 'and').replace(/'/g, "");
    if (name === "Durov's Cap") filename = "Durov's-Cap";
    if (name === "Vintage Cigar") filename = "Vintage-Cigar";
    if (name === "placeholder_nothing.png") return 'https://images.emojiterra.com/mozilla/512px/274c.png';
    if (['Amber', 'Midnight_Blue', 'Onyx_Black', 'Black'].includes(name.replace(/-/g, '_'))) filename = name.replace('-', '_');
    if (!/\.(jpeg|jpg|gif|png|svg)$/i.test(filename)) filename += '.png';
    return IMAGE_BASE_URL + filename;
}

const finalKissedFrogPrizesWithConsolation = [ // Sorted by floorPrice DESC
    {'name':'Happy Pepe','probability':0.0000850,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Happy%20Pepe.png','floorPrice':500.0},
    {'name':'Tree Frog','probability':0.0004250,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Tree%20Frog.png','floorPrice':150.0},
    {'name':'Brewtoad','probability':0.0004250,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Brewtoad.png','floorPrice':150.0},
    {'name':'Puddles','probability':0.0004250,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Puddles.png','floorPrice':150.0},
    {'name':'Honeyhop','probability':0.0004250,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Honeyhop.png','floorPrice':150.0},
    {'name':'Melty Butter','probability':0.0004250,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Melty%20Butter.png','floorPrice':150.0},
    {'name':'Lucifrog','probability':0.0004250,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Lucifrog.png','floorPrice':150.0},
    {'name':'Zodiak Croak','probability':0.0004250,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Zodiak%20Croak.png','floorPrice':150.0},
    {'name':'Count Croakula','probability':0.0004250,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Count%20Croakula.png','floorPrice':150.0},
    {'name':'Lilie Pond','probability':0.0004250,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Lilie%20Pond.png','floorPrice':150.0},
    {'name':'Sweet Dream','probability':0.0004250,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Sweet%20Dream.png','floorPrice':150.0},
    {'name':'Frogmaid','probability':0.0004250,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Frogmaid.png','floorPrice':150.0},
    {'name':'Rocky Hopper','probability':0.0004250,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Rocky%20Hopper.png','floorPrice':150.0},
    {'name':'Icefrog','probability':0.0017000,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Icefrog.png','floorPrice':45.0},
    {'name':'Lava Leap','probability':0.0017000,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Lava%20Leap.png','floorPrice':45.0},
    {'name':'Toadstool','probability':0.0017000,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Toadstool.png','floorPrice':45.0},
    {'name':'Desert Frog','probability':0.0017000,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Desert%20Frog.png','floorPrice':45.0},
    {'name':'Cupid','probability':0.0017000,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Cupid.png','floorPrice':45.0},
    {'name':'Hopberry','probability':0.0017000,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Hopberry.png','floorPrice':45.0},
    {'name':'Ms. Toad','probability':0.0017000,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Ms.%20Toad.png','floorPrice':45.0},
    {'name':'Trixie','probability':0.0017000,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Trixie.png','floorPrice':45.0},
    {'name':'Prince Ribbit','probability':0.0017000,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Prince%20Ribbit.png','floorPrice':45.0},
    {'name':'Pond Fairy','probability':0.0017000,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Pond%20Fairy.png','floorPrice':45.0},
    {'name':'Boingo','probability':0.0017000,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Boingo.png','floorPrice':45.0},
    {'name':'Tesla Frog','probability':0.0017000,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Tesla%20Frog.png','floorPrice':45.0},
    {'name':'Starry Night','probability':0.0059500,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Starry%20Night.png','floorPrice':30.0},
    {'name':'Silver','probability':0.0059500,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Silver.png','floorPrice':30.0},
    {'name':'Ectofrog','probability':0.0059500,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Ectofrog.png','floorPrice':30.0},
    {'name':'Poison','probability':0.0059500,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Poison.png','floorPrice':30.0},
    {'name':'Minty Bloom','probability':0.0059500,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Minty%20Bloom.png','floorPrice':30.0},
    {'name':'Sarutoad','probability':0.0059500,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Sarutoad.png','floorPrice':30.0},
    {'name':'Void Hopper','probability':0.0059500,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Void%20Hopper.png','floorPrice':30.0},
    {'name':'Ramune','probability':0.0059500,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Ramune.png','floorPrice':30.0},
    {'name':'Lemon Drop','probability':0.0059500,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Lemon%20Drop.png','floorPrice':30.0},
    {'name':'Ectobloom','probability':0.0059500,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Ectobloom.png','floorPrice':30.0},
    {'name':'Duskhopper','probability':0.0059500,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Duskhopper.png','floorPrice':30.0},
    {'name':'Bronze','probability':0.0059500,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Bronze.png','floorPrice':30.0},
    {'name':'Lily Pond','probability':0.0342380,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Lily%20Pond.png','floorPrice':19.0},
    {'name':'Toadberry','probability':0.0342380,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Toadberry.png','floorPrice':19.0},
    {'name':'Frogwave','probability':0.0342380,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Frogwave.png','floorPrice':19.0},
    {'name':'Melon','probability':0.0342380,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Melon.png','floorPrice':19.0},
    {'name':'Sky Leaper','probability':0.0342380,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Sky%20Leaper.png','floorPrice':19.0},
    {'name':'Frogtart','probability':0.0342380,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Frogtart.png','floorPrice':19.0},
    {'name':'Peach','probability':0.0342380,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Peach.png','floorPrice':19.0},
    {'name':'Sea Breeze','probability':0.0342380,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Sea%20Breeze.png','floorPrice':19.0},
    {'name':'Lemon Juice','probability':0.0342380,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Lemon%20Juice.png','floorPrice':19.0},
    {'name':'Cranberry','probability':0.0342380,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Cranberry.png','floorPrice':19.0},
    {'name':'Tide Pod','probability':0.0342380,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Tide%20Pod.png','floorPrice':19.0},
    {'name':'Brownie','probability':0.0342380,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Brownie.png','floorPrice':19.0},
    {'name':'Banana Pox','probability':0.0342340,'imageFilename':'https://cdn.changes.tg/gifts/models/Kissed%20Frog/png/Banana%20Pox.png','floorPrice':19.0},
    {'name':'Desk Calendar','probability':0.0000000,'imageFilename':'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/GiftImages/Desk-Calendar.png','floorPrice':1.4}
].sort((a,b) => (b.floorPrice || 0) - (a.floorPrice || 0));
let currentProbSumForKF = finalKissedFrogPrizesWithConsolation.reduce((sum,p)=>sum+p.probability,0);
let remainingProbForConsolation = 1.0 - currentProbSumForKF;
if(remainingProbForConsolation > 0.00001){finalKissedFrogPrizesWithConsolation.push({name:"Desk Calendar",probability:remainingProbForConsolation});}
finalKissedFrogPrizesWithConsolation.forEach(p=>{if(!p.imageFilename)p.imageFilename=generateImageFilename(p.name);if(p.floorPrice===undefined)p.floorPrice=UPDATED_FLOOR_PRICES_FRONTEND[p.name];});

const casesData = [
    {id:'all_in_01',name:'All In','imageFilename':'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/caseImages/All-In.jpg','priceTON':0.1,'prizes':[
        // Illustrative RTP adjusted probabilities
        {name:'Plush Pepe',probability: 0.000007, imageFilename:generateImageFilename('Plush Pepe'), floorPrice:1200.0, is_ton_prize:false},
        {name:'Durov\'s Cap',probability: 0.00007, imageFilename:generateImageFilename('Durov\'s Cap'), floorPrice:251.0, is_ton_prize:false},
        {name:'Precious Peach',probability: 0.0002, imageFilename:generateImageFilename('Precious Peach'), floorPrice:162.0, is_ton_prize:false},
        {name:'Bonded Ring',probability: 0.0007, imageFilename:generateImageFilename('Bonded Ring'), floorPrice:60.5, is_ton_prize:false},
        {name:'Lol Pop',probability: 0.079023, imageFilename:generateImageFilename('Lol Pop'), floorPrice:1.4, is_ton_prize:false},
        {name:'Nothing',probability: 0.92, imageFilename: 'placeholder_nothing.png', floorPrice:0.0, is_ton_prize:false} // Placeholder
    ].sort((a,b) => (b.floorPrice || 0) - (a.floorPrice || 0))},

    // --- NEW CASE: Small Billionaire ---
    {id:'small_billionaire_05','name':'Small Billionaire','imageFilename':'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/caseImages/Small-Billionaire.jpg','priceTON':0.5,'prizes':[
        // Illustrative RTP adjusted probabilities
        {name:'Perfume Bottle',probability: 0.008, imageFilename:generateImageFilename('Perfume Bottle'), floorPrice:38.3, is_ton_prize:false},
        {name:'Vintage Cigar',probability: 0.010, imageFilename:generateImageFilename('Vintage Cigar'), floorPrice:19.7, is_ton_prize:false},
        {name:'Signet Ring',probability: 0.012, imageFilename:generateImageFilename('Signet Ring'), floorPrice:18.8, is_ton_prize:false},
        {name:'Swiss Watch',probability: 0.020, imageFilename:generateImageFilename('Swiss Watch'), floorPrice:18.6, is_ton_prize:false},
        {name:'Snake Box', probability: 0.04, imageFilename:generateImageFilename('Snake Box'), floorPrice:3.3, is_ton_prize:false},
        {name:'Nothing',probability: 0.95, imageFilename: 'placeholder_nothing.png', floorPrice:0.0, is_ton_prize:false}
    ].sort((a,b) => (b.floorPrice || 0) - (a.floorPrice || 0))},
    {id:'lolpop',name:'Lol Pop Stash',imageFilename:'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/caseImages/Lol-Pop.jpg',priceTON:2.0,prizes:[
        {name:'Plush Pepe',probability:0.0000454,imageFilename:generateImageFilename('Plush Pepe'),floorPrice:1200.0,is_ton_prize:false},
        {name:'Neko Helmet',probability:0.001362,imageFilename:generateImageFilename('Neko Helmet'),floorPrice:15.0,is_ton_prize:false},
        {name:'Snake Box',probability:0.029800,imageFilename:generateImageFilename('Snake Box'),floorPrice:3.3,is_ton_prize:false},
        {name:'Pet Snake',probability:0.030500,imageFilename:generateImageFilename('Pet Snake'),floorPrice:3.2,is_ton_prize:false},
        {name:'Xmas Stocking',probability:0.038500,imageFilename:generateImageFilename('Xmas Stocking'),floorPrice:2.5,is_ton_prize:false},
        {name:'Spiced Wine',probability:0.0454378,imageFilename:generateImageFilename('Spiced Wine'),floorPrice:2.2,is_ton_prize:false},
        {name:'Party Sparkler',probability:0.081816,imageFilename:generateImageFilename('Party Sparkler'),floorPrice:2.0,is_ton_prize:false},
        {name:'Homemade Cake',probability:0.081816,imageFilename:generateImageFilename('Homemade Cake'),floorPrice:2.0,is_ton_prize:false},
        {name:'Jack-in-the-box',probability:0.081816,imageFilename:generateImageFilename('Jack-in-the-box'),floorPrice:2.0,is_ton_prize:false},
        {name:'Santa Hat',probability:0.0454378,imageFilename:generateImageFilename('Santa Hat'),floorPrice:2.0,is_ton_prize:false},
        {name:'Jester Hat',probability:0.0454378,imageFilename:generateImageFilename('Jester Hat'),floorPrice:2.0,is_ton_prize:false},
        {name:'Winter Wreath',probability:0.0454378,imageFilename:generateImageFilename('Winter Wreath'),floorPrice:2.0,is_ton_prize:false},
        {name:'Cookie Heart',probability:0.081816,imageFilename:generateImageFilename('Cookie Heart'),floorPrice:1.8,is_ton_prize:false},
        {name:'Easter Egg',probability:0.0454378,imageFilename:generateImageFilename('Easter Egg'),floorPrice:1.8,is_ton_prize:false},
        {name:'Jingle Bells',probability:0.0454378,imageFilename:generateImageFilename('Jingle Bells'),floorPrice:1.8,is_ton_prize:false},
        {name:'Candy Cane',probability:0.0454378,imageFilename:generateImageFilename('Candy Cane'),floorPrice:1.6,is_ton_prize:false},
        {name:'Lunar Snake',probability:0.0454378,imageFilename:generateImageFilename('Lunar Snake'),floorPrice:1.5,is_ton_prize:false},
        {name:'Lol Pop',probability:0.153405,imageFilename:generateImageFilename('Lol Pop'),floorPrice:1.4,is_ton_prize:false},
        {name:'Hypno Lollipop',probability:0.153405,imageFilename:generateImageFilename('Hypno Lollipop'),floorPrice:1.4,is_ton_prize:false},
        {name:'Desk Calendar',probability:0.0454378,imageFilename:generateImageFilename('Desk Calendar'),floorPrice:1.4,is_ton_prize:false},
        {name:'B-Day Candle',probability:0.0454378,imageFilename:generateImageFilename('B-Day Candle'),floorPrice:1.4,is_ton_prize:false},
        {name:'Skull Flower',probability:0.0357945,imageFilename:generateImageFilename('Skull Flower'),floorPrice:3.4,is_ton_prize:false} // This was out of order
    ].sort((a,b) => (b.floorPrice || 0) - (a.floorPrice || 0))},

    {id:'recordplayer',name:'Record Player Vault',imageFilename:'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/caseImages/Record-Player.jpg',priceTON:3.0,prizes:[
        {name:'Plush Pepe',probability:0.0001594,imageFilename:generateImageFilename('Plush Pepe'),floorPrice:1200.0,is_ton_prize:false},
        {name:'Crystal Ball',probability:0.03189,imageFilename:generateImageFilename('Crystal Ball'),floorPrice:6.0,is_ton_prize:false},
        {name:'Flying Broom',probability:0.03189,imageFilename:generateImageFilename('Flying Broom'),floorPrice:4.5,is_ton_prize:false},
        {name:'Big Year',probability:0.01500,imageFilename:generateImageFilename('Big Year'),floorPrice:4.4,is_ton_prize:false},
        {name:'Evil Eye',probability:0.03189,imageFilename:generateImageFilename('Evil Eye'),floorPrice:4.2,is_ton_prize:false},
        {name:'Berry Box',probability:0.03189,imageFilename:generateImageFilename('Berry Box'),floorPrice:4.1,is_ton_prize:false},
        {name:'Tama Gadget',probability:0.074404,imageFilename:generateImageFilename('Tama Gadget'),floorPrice:4.0,is_ton_prize:false},
        {name:'Snow Globe',probability:0.06378,imageFilename:generateImageFilename('Snow Globe'),floorPrice:4.0,is_ton_prize:false},
        {name:'Record Player',probability:0.15942,imageFilename:generateImageFilename('Record Player'),floorPrice:4.0,is_ton_prize:false},
        {name:'Bunny Muffin',probability:0.03189,imageFilename:generateImageFilename('Bunny Muffin'),floorPrice:4.0,is_ton_prize:false},
        {name:'Jelly Bunny',probability:0.085024,imageFilename:generateImageFilename('Jelly Bunny'),floorPrice:3.6,is_ton_prize:false},
        {name:'Skull Flower',probability:0.085024,imageFilename:generateImageFilename('Skull Flower'),floorPrice:3.4,is_ton_prize:false},
        {name:'Snake Box',probability:0.02100,imageFilename:generateImageFilename('Snake Box'),floorPrice:3.3,is_ton_prize:false},
        {name:'Pet Snake',probability:0.02800,imageFilename:generateImageFilename('Pet Snake'),floorPrice:3.2,is_ton_prize:false},
        {name:'Eternal Candle',probability:0.03189,imageFilename:generateImageFilename('Eternal Candle'),floorPrice:3.1,is_ton_prize:false},
        {name:'Hex Pot',probability:0.03189,imageFilename:generateImageFilename('Hex Pot'),floorPrice:3.1,is_ton_prize:false},
        {name:'Snow Mittens',probability:0.03189,imageFilename:generateImageFilename('Snow Mittens'),floorPrice:2.9,is_ton_prize:false},
        {name:'Spy Agaric',probability:0.03189,imageFilename:generateImageFilename('Spy Agaric'),floorPrice:2.8,is_ton_prize:false},
        {name:'Star Notepad',probability:0.03189,imageFilename:generateImageFilename('Star Notepad'),floorPrice:2.8,is_ton_prize:false},
        {name:'Ginger Cookie',probability:0.03189,imageFilename:generateImageFilename('Ginger Cookie'),floorPrice:2.7,is_ton_prize:false},
        {name:'Xmas Stocking',probability:0.02500,imageFilename:generateImageFilename('Xmas Stocking'),floorPrice:2.5,is_ton_prize:false},
        {name:'Party Sparkler',probability:0.10628,imageFilename:generateImageFilename('Party Sparkler'),floorPrice:2.0,is_ton_prize:false},
        {name:'Lol Pop',probability:0.10628,imageFilename:generateImageFilename('Lol Pop'),floorPrice:1.4,is_ton_prize:false},
        {name:'Hypno Lollipop',probability:0.10628,imageFilename:generateImageFilename('Hypno Lollipop'),floorPrice:1.4,is_ton_prize:false}
    ].sort((a,b) => (b.floorPrice || 0) - (a.floorPrice || 0))},

    {id: 'girls_collection', name: 'Girl\'s Collection', imageFilename: 'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/caseImages/girls.jpg', priceTON: 8.0, prizes: [
        {name: 'Loot Bag', probability: 0.0010, imageFilename:generateImageFilename('Loot Bag'), floorPrice:25.0, is_ton_prize:false},
        {name: 'Genie Lamp', probability: 0.0100, imageFilename:generateImageFilename('Genie Lamp'), floorPrice:19.3, is_ton_prize:false},
        {name: 'Sharp Tongue', probability: 0.0160, imageFilename:generateImageFilename('Sharp Tongue'), floorPrice:17.0, is_ton_prize:false},
        {name: 'Toy Bear', probability: 0.0200, imageFilename:generateImageFilename('Toy Bear'), floorPrice:16.3, is_ton_prize:false},
        {name: 'Neko Helmet', probability: 0.0180, imageFilename:generateImageFilename('Neko Helmet'), floorPrice:15.0, is_ton_prize:false},
        {name: 'Eternal Rose', probability: 0.0300, imageFilename:generateImageFilename('Eternal Rose'), floorPrice:11.0, is_ton_prize:false},
        {name: 'Berry Box', probability: 0.0900, imageFilename:generateImageFilename('Berry Box'), floorPrice:4.1, is_ton_prize:false},
        {name: 'Sakura Flower', probability: 0.0900, imageFilename:generateImageFilename('Sakura Flower'), floorPrice:4.1, is_ton_prize:false},
        {name: 'Bunny Muffin', probability: 0.0950, imageFilename:generateImageFilename('Bunny Muffin'), floorPrice:4.0, is_ton_prize:false},
        {name: 'Star Notepad', probability: 0.1100, imageFilename:generateImageFilename('Star Notepad'), floorPrice:2.8, is_ton_prize:false},
        {name: 'Cookie Heart', probability: 0.1250, imageFilename:generateImageFilename('Cookie Heart'), floorPrice:1.8, is_ton_prize:false}
    ].sort((a,b) => (b.floorPrice || 0) - (a.floorPrice || 0))},

    {id: 'mens_collection', name: 'Men\'s Collection', imageFilename: 'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/caseImages/men.jpg', priceTON: 8.0, prizes: [
        {name: 'Durov\'s Cap', probability: 0.00005, imageFilename:generateImageFilename('Durov\'s Cap'), floorPrice:251.0, is_ton_prize:false},
        {name: 'Mini Oscar', probability: 0.0050, imageFilename:generateImageFilename('Mini Oscar'), floorPrice:40.5, is_ton_prize:false},
        {name: 'Perfume Bottle', probability: 0.0060, imageFilename:generateImageFilename('Perfume Bottle'), floorPrice:38.3, is_ton_prize:false},
        {name: 'Scared Cat', probability: 0.0100, imageFilename:generateImageFilename('Scared Cat'), floorPrice:22.0, is_ton_prize:false},
        {name: 'Vintage Cigar', probability: 0.0150, imageFilename:generateImageFilename('Vintage Cigar'), floorPrice:19.7, is_ton_prize:false},
        {name: 'Signet Ring', probability: 0.0200, imageFilename:generateImageFilename('Signet Ring'), floorPrice:18.8, is_ton_prize:false},
        {name: 'Swiss Watch', probability: 0.0200, imageFilename:generateImageFilename('Swiss Watch'), floorPrice:18.6, is_ton_prize:false},
        {name: 'Top Hat', probability: 0.0700, imageFilename:generateImageFilename('Top Hat'), floorPrice:6.0, is_ton_prize:false},
        {name: 'Record Player', probability: 0.0900, imageFilename:generateImageFilename('Record Player'), floorPrice:4.0, is_ton_prize:false},
        {name: 'Spiced Wine', probability: 0.1300, imageFilename:generateImageFilename('Spiced Wine'), floorPrice:2.2, is_ton_prize:false}
    ].sort((a,b) => (b.floorPrice || 0) - (a.floorPrice || 0))},

    {id:'swisswatch',name:'Swiss Watch Box',imageFilename:'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/caseImages/Swiss-Watch.jpg',priceTON:10.0,prizes:[
        {name:'Plush Pepe',probability:0.0001994,imageFilename:generateImageFilename('Plush Pepe'),floorPrice:1200.0,is_ton_prize:false},
        {name:'Signet Ring',probability:0.03988,imageFilename:generateImageFilename('Signet Ring'),floorPrice:18.8,is_ton_prize:false},
        {name:'Swiss Watch',probability:0.031904,imageFilename:generateImageFilename('Swiss Watch'),floorPrice:18.6,is_ton_prize:false},
        {name:'Neko Helmet',probability:0.044865,imageFilename:generateImageFilename('Neko Helmet'),floorPrice:15.0,is_ton_prize:false},
        {name:'Eternal Rose',probability:0.05982,imageFilename:generateImageFilename('Eternal Rose'),floorPrice:11.0,is_ton_prize:false},
        {name:'Electric Skull',probability:0.07976,imageFilename:generateImageFilename('Electric Skull'),floorPrice:10.9,is_ton_prize:false},
        {name:'Voodoo Doll',probability:0.14955,imageFilename:generateImageFilename('Voodoo Doll'),floorPrice:9.4,is_ton_prize:false},
        {name:'Diamond Ring',probability:0.0997,imageFilename:generateImageFilename('Diamond Ring'),floorPrice:8.06,is_ton_prize:false},
        {name:'Love Candle',probability:0.03988,imageFilename:generateImageFilename('Love Candle'),floorPrice:6.7,is_ton_prize:false},
        {name:'Mad Pumpkin',probability:0.03988,imageFilename:generateImageFilename('Mad Pumpkin'),floorPrice:6.2,is_ton_prize:false},
        {name:'Sleigh Bell',probability:0.03988,imageFilename:generateImageFilename('Sleigh Bell'),floorPrice:6.0,is_ton_prize:false},
        {name:'Top Hat',probability:0.11964,imageFilename:generateImageFilename('Top Hat'),floorPrice:6.0,is_ton_prize:false},
        {name:'Trapped Heart',probability:0.03988,imageFilename:generateImageFilename('Trapped Heart'),floorPrice:6.0,is_ton_prize:false},
        {name:'Love Potion',probability:0.11964,imageFilename:generateImageFilename('Love Potion'),floorPrice:5.4,is_ton_prize:false},
        {name:'Big Year',probability:0.02500,imageFilename:generateImageFilename('Big Year'),floorPrice:4.4,is_ton_prize:false},
        {name:'Record Player',probability:0.11964,imageFilename:generateImageFilename('Record Player'),floorPrice:4.0,is_ton_prize:false},
        {name:'Snake Box',probability:0.02600,imageFilename:generateImageFilename('Snake Box'),floorPrice:3.3,is_ton_prize:false},
        {name:'Pet Snake',probability:0.02950,imageFilename:generateImageFilename('Pet Snake'),floorPrice:3.2,is_ton_prize:false},
        {name:'Xmas Stocking',probability:0.03400,imageFilename:generateImageFilename('Xmas Stocking'),floorPrice:2.5,is_ton_prize:false}
    ].sort((a,b) => (b.floorPrice || 0) - (a.floorPrice || 0))},

    {id:'kissedfrog',name:'Kissed Frog Pond',imageFilename:'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/caseImages/Kissed-Frog.jpg',priceTON:20.0,prizes:finalKissedFrogPrizesWithConsolation},

    {id:'perfumebottle',name:'Perfume Chest',imageFilename:'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/caseImages/Perfume-Bottle.jpg',priceTON:20.0,prizes:[
        {name:'Plush Pepe',probability:0.000402,imageFilename:generateImageFilename('Plush Pepe'),floorPrice:1200.0,is_ton_prize:false},
        {name:'Bonded Ring',probability:0.00100,imageFilename:generateImageFilename('Bonded Ring'),floorPrice:60.5,is_ton_prize:false},
        {name:'Ion Gem',probability:0.0402000,imageFilename:generateImageFilename('Ion Gem'),floorPrice:44.0,is_ton_prize:false},
        {name:'Perfume Bottle',probability:0.0201000,imageFilename:generateImageFilename('Perfume Bottle'),floorPrice:38.3,is_ton_prize:false},
        {name:'Magic Potion',probability:0.05025,imageFilename:generateImageFilename('Magic Potion'),floorPrice:33.0,is_ton_prize:false},
        {name:'Loot Bag',probability:0.05025,imageFilename:generateImageFilename('Loot Bag'),floorPrice:25.0,is_ton_prize:false},
        {name:'Genie Lamp',probability:0.1105500,imageFilename:generateImageFilename('Genie Lamp'),floorPrice:19.3,is_ton_prize:false},
        {name:'Swiss Watch',probability:0.0603000,imageFilename:generateImageFilename('Swiss Watch'),floorPrice:18.6,is_ton_prize:false},
        {name:'Sharp Tongue',probability:0.0351750,imageFilename:generateImageFilename('Sharp Tongue'),floorPrice:17.0,is_ton_prize:false},
        {name:'Neko Helmet',probability:0.0804000,imageFilename:generateImageFilename('Neko Helmet'),floorPrice:15.0,is_ton_prize:false},
        {name:'Kissed Frog',probability:0.1507500,imageFilename:generateImageFilename('Kissed Frog'),floorPrice:14.8,is_ton_prize:false},
        {name:'Electric Skull',probability:0.2010000,imageFilename:generateImageFilename('Electric Skull'),floorPrice:10.9,is_ton_prize:false},
        {name:'Diamond Ring',probability:0.2010000,imageFilename:generateImageFilename('Diamond Ring'),floorPrice:8.06,is_ton_prize:false},
        {name:'Big Year',probability:0.01500,imageFilename:generateImageFilename('Big Year'),floorPrice:4.4,is_ton_prize:false},
        {name:'Snake Box',probability:0.01600,imageFilename:generateImageFilename('Snake Box'),floorPrice:3.3,is_ton_prize:false},
        {name:'Pet Snake',probability:0.02000,imageFilename:generateImageFilename('Pet Snake'),floorPrice:3.2,is_ton_prize:false}
    ].sort((a,b) => (b.floorPrice || 0) - (a.floorPrice || 0))},

    {id:'vintagecigar',name:'Vintage Cigar Safe',imageFilename:'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/caseImages/Vintage-Cigar.jpg',priceTON:40.0,prizes:[
        {name:'Plush Pepe',probability:0.000804,imageFilename:generateImageFilename('Plush Pepe'),floorPrice:1200.0,is_ton_prize:false},
        {name:'Precious Peach',probability:0.0201000,imageFilename:generateImageFilename('Precious Peach'),floorPrice:162.0,is_ton_prize:false},
        {name:'Bonded Ring',probability:0.00050,imageFilename:generateImageFilename('Bonded Ring'),floorPrice:60.5,is_ton_prize:false},
        {name:'Mini Oscar',probability:0.07035,imageFilename:generateImageFilename('Mini Oscar'),floorPrice:40.5,is_ton_prize:false},
        {name:'Perfume Bottle',probability:0.0251250,imageFilename:generateImageFilename('Perfume Bottle'),floorPrice:38.3,is_ton_prize:false},
        {name:'Scared Cat',probability:0.2010000,imageFilename:generateImageFilename('Scared Cat'),floorPrice:22.0,is_ton_prize:false},
        {name:'Vintage Cigar',probability:0.0301500,imageFilename:generateImageFilename('Vintage Cigar'),floorPrice:19.7,is_ton_prize:false},
        {name:'Genie Lamp',probability:0.1005000,imageFilename:generateImageFilename('Genie Lamp'),floorPrice:19.3,is_ton_prize:false},
        {name:'Swiss Watch',probability:0.0402000,imageFilename:generateImageFilename('Swiss Watch'),floorPrice:18.6,is_ton_prize:false},
        {name:'Sharp Tongue',probability:0.0804000,imageFilename:generateImageFilename('Sharp Tongue'),floorPrice:17.0,is_ton_prize:false},
        {name:'Toy Bear',probability:0.3957930,imageFilename:generateImageFilename('Toy Bear'),floorPrice:16.3,is_ton_prize:false},
        {name:'Neko Helmet',probability:0.0603000,imageFilename:generateImageFilename('Neko Helmet'),floorPrice:15.0,is_ton_prize:false},
        {name:'Big Year',probability:0.01000,imageFilename:generateImageFilename('Big Year'),floorPrice:4.4,is_ton_prize:false},
        {name:'Snake Box',probability:0.01100,imageFilename:generateImageFilename('Snake Box'),floorPrice:3.3,is_ton_prize:false},
        {name:'Pet Snake',probability:0.01200,imageFilename:generateImageFilename('Pet Snake'),floorPrice:3.2,is_ton_prize:false}
    ].sort((a,b) => (b.floorPrice || 0) - (a.floorPrice || 0))},

    {id:'astralshard',name:'Astral Shard Relic',imageFilename:'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/caseImages/Astral-Shard.jpg',priceTON:100.0,prizes:[
        {name:'Plush Pepe',probability:0.0015075,imageFilename:generateImageFilename('Plush Pepe'),floorPrice:1200.0,is_ton_prize:false},
        {name:'Durov\'s Cap',probability:0.0100500,imageFilename:generateImageFilename('Durov\'s Cap'),floorPrice:251.0,is_ton_prize:false},
        {name:'Precious Peach',probability:0.05025,imageFilename:generateImageFilename('Precious Peach'),floorPrice:162.0,is_ton_prize:false},
        {name:'Bonded Ring',probability:0.00100,imageFilename:generateImageFilename('Bonded Ring'),floorPrice:60.5,is_ton_prize:false},
        {name:'Astral Shard',probability:0.0251250,imageFilename:generateImageFilename('Astral Shard'),floorPrice:50.0,is_ton_prize:false},
        {name:'Ion Gem',probability:0.03015,imageFilename:generateImageFilename('Ion Gem'),floorPrice:44.0,is_ton_prize:false},
        {name:'Mini Oscar',probability:0.0603000,imageFilename:generateImageFilename('Mini Oscar'),floorPrice:40.5,is_ton_prize:false},
        {name:'Perfume Bottle',probability:0.05025,imageFilename:generateImageFilename('Perfume Bottle'),floorPrice:38.3,is_ton_prize:false},
        {name:'Magic Potion',probability:0.03015,imageFilename:generateImageFilename('Magic Potion'),floorPrice:33.0,is_ton_prize:false},
        {name:'Loot Bag',probability:0.2010000,imageFilename:generateImageFilename('Loot Bag'),floorPrice:25.0,is_ton_prize:false},
        {name:'Scared Cat',probability:0.1507500,imageFilename:generateImageFilename('Scared Cat'),floorPrice:22.0,is_ton_prize:false},
        {name:'Vintage Cigar',probability:0.0402000,imageFilename:generateImageFilename('Vintage Cigar'),floorPrice:19.7,is_ton_prize:false},
        {name:'Swiss Watch',probability:0.07035,imageFilename:generateImageFilename('Swiss Watch'),floorPrice:18.6,is_ton_prize:false},
        {name:'Toy Bear',probability:0.2010000,imageFilename:generateImageFilename('Toy Bear'),floorPrice:16.3,is_ton_prize:false},
        {name:'Neko Helmet',probability:0.09045,imageFilename:generateImageFilename('Neko Helmet'),floorPrice:15.0,is_ton_prize:false},
        {name:'Big Year',probability:0.00600,imageFilename:generateImageFilename('Big Year'),floorPrice:4.4,is_ton_prize:false},
        {name:'Pet Snake',probability:0.00800,imageFilename:generateImageFilename('Pet Snake'),floorPrice:3.2,is_ton_prize:false}
    ].sort((a,b) => (b.floorPrice || 0) - (a.floorPrice || 0))},

    {id:'plushpepe',name:'Plush Pepe Hoard',imageFilename:'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/caseImages/Plush-Pepe.jpg',priceTON:200.0,prizes:[
        {name:'Plush Pepe',probability:0.0454395,imageFilename:generateImageFilename('Plush Pepe'),floorPrice:1200.0,is_ton_prize:false},
        {name:'Durov\'s Cap',probability:0.2019445,imageFilename:generateImageFilename('Durov\'s Cap'),floorPrice:251.0,is_ton_prize:false},
        {name:'Precious Peach',probability:0.3029168,imageFilename:generateImageFilename('Precious Peach'),floorPrice:162.0,is_ton_prize:false},
        {name:'Bonded Ring',probability:0.0458102,imageFilename:generateImageFilename('Bonded Ring'),floorPrice:60.5,is_ton_prize:false},
        {name:'Astral Shard',probability:0.4038890,imageFilename:generateImageFilename('Astral Shard'),floorPrice:50.0,is_ton_prize:false}
    ].sort((a,b) => (b.floorPrice || 0) - (a.floorPrice || 0))}
];

casesData.forEach(caseItem => {
    if (caseItem.id === 'kissedfrog') return;

    let totalProb = caseItem.prizes.reduce((sum, prize) => sum + prize.probability, 0);
    if (totalProb > 0 && Math.abs(totalProb - 1.0) > 0.0001) {
        const factor = 1.0 / totalProb;
        caseItem.prizes.forEach(prize => { prize.probability *= factor; });
    }
    caseItem.prizes.sort((a,b) => (b.floorPrice || 0) - (a.floorPrice || 0));
});

// DOM Element References
const headerElements = {
    tonConnectButton: document.getElementById('ton-connect-button'),
    walletAddressDisplay: document.getElementById('wallet-address-display'),
    tonBalanceSpan: document.getElementById('ton-balance'),
    balanceDisplay: document.getElementById('balance')
};
const appNavButtons = document.querySelectorAll('.nav-button');
const pages = document.querySelectorAll('.page');
const casesGrid = document.getElementById('cases-grid');
const loadingScreen = document.getElementById('loading-screen');
const loadingStatusText = document.getElementById('loading-status');
const rouletteModal = document.getElementById('roulette-modal');
const rouletteCaseName = document.getElementById('roulette-case-name');
const rouletteWheelContainer = document.getElementById('roulette-wheel-container');
const spinButton = document.getElementById('spin-button');
const closeRouletteButton = document.getElementById('close-roulette-button');
const possiblePrizesDisplay = document.getElementById('possible-prizes-display');
const caseMultiplierSelector = document.querySelector('.case-multiplier-selector');

// NEW GLOBAL REFERENCES FOR REELS (for the 3-reel slot machine visual)
// These elements are guaranteed to exist in the HTML structure now.
const rouletteReel1 = document.getElementById('roulette-reel-1'); // Get the parent container
const rouletteReel2 = document.getElementById('roulette-reel-2'); // Get the parent container
const rouletteReel3 = document.getElementById('roulette-reel-3'); // Get the parent container

const winOverlayModal = document.getElementById('win-overlay-modal');
const winOverlayPrizeImageContainer = document.getElementById('win-overlay-prize-image');
const winOverlayNameEl = document.getElementById('win-overlay-prize-name');
const winOverlayPrizeDetailsEl = document.getElementById('win-overlay-prize-details');
const winOverlaySaveBtn = document.getElementById('win-overlay-save-button');
const winOverlayConvertBtn = document.getElementById('win-overlay-convert-button');
const winOverlayConvertValue = document.getElementById('win-overlay-convert-value');

const withdrawModal = document.getElementById('withdraw-modal');
const withdrawSteps = withdrawModal.querySelectorAll('.modal-step');
const withdrawStep2NextBtn = document.getElementById('withdraw-step2-next');
const withdrawStep2BackBtn = document.getElementById('withdraw-step2-back');
const withdrawStatusMessage = document.getElementById('withdraw-status-message');
const closeWithdrawModalButton = document.getElementById('close-withdraw-modal-button');

const profileElements = {
    avatar: document.getElementById('profile-avatar'),
    username: document.getElementById('profile-username'),
    userid: document.getElementById('profile-userid'),
    balanceDisplay: document.getElementById('profile-balance-display'),
    walletAddress: document.getElementById('profile-wallet-address'),
    inventoryGrid: document.getElementById('inventory-grid'),
    inventoryCount: document.getElementById('inventory-count'),
    emptyInventoryMessage: document.getElementById('empty-inventory-message'),
    disconnectWalletButton: document.getElementById('disconnect-wallet-button'),
    depositAmountInput: document.getElementById('deposit-amount-input'),
    initiateDepositButton: document.getElementById('initiate-deposit-button'),
    sellAllButton: document.getElementById('sell-all-button'),
    sellAllValueSpan: document.getElementById('sell-all-value'),
    promocodeInput: document.getElementById('promocode-input'),
    redeemPromocodeButton: document.getElementById('redeem-promocode-button')
};
const upgradePageElements = { // Changed from 'upgradeElements' to avoid conflict
    selectedInventoryItemSlot: document.getElementById('selected-inventory-item-slot'),
    desiredUpgradeItemSlot: document.getElementById('desired-upgrade-item-slot'),
    
    upgradePickerContainer: document.getElementById('upgrade-picker-container'),
    upgradePickerTitle: document.getElementById('upgrade-picker-title'),
    upgradeItemsGrid: document.getElementById('upgrade-items-grid'),
    closeUpgradePickerButton: document.getElementById('close-upgrade-picker-button'),

    chanceDisplayContainer: document.getElementById('upgrade-chance-display-container'),
    chanceCircle: document.getElementById('upgrade-chance-circle'),
    chancePointer: document.getElementById('upgrade-chance-pointer'),
    calculatedMultiplierText: document.getElementById('upgrade-calculated-multiplier'),
    calculatedChanceText: document.getElementById('upgrade-calculated-chance'),
    doUpgradeButton: document.getElementById('do-upgrade-button'),

    // New result modal elements
    upgradeResultModal: document.getElementById('upgrade-result-modal'),
    upgradeResultImageContainer: document.getElementById('upgrade-result-image-container'),
    upgradeResultTitle: document.getElementById('upgrade-result-title'),
    upgradeResultMessage: document.getElementById('upgrade-result-message'),
    closeUpgradeResultModalButton: document.getElementById('close-upgrade-result-modal-button'),
};
const upgradeElements = {
    inventorySelect: document.getElementById('upgrade-inventory-select'),
    multiplierButtons: document.getElementById('multiplier-buttons'),
    doUpgradeButton: document.getElementById('do-upgrade-button'),
    upgradeResult: document.getElementById('upgrade-result'),
    chanceDisplay: document.getElementById('upgrade-chance-display')
};
const inviteElements = {
    referralLink: document.getElementById('referral-link'),
    copyRefLinkButton: document.getElementById('copy-ref-link-button'),
    referralBalance: document.getElementById('referral-balance'),
    invitedCount: document.getElementById('invited-count'),
    withdrawReferralButton: document.getElementById('withdraw-referral-button'),
    invitedUsersListDisplay: document.getElementById('invited-users-list-display')
};
const leaderboardList = document.getElementById('leaderboard-list');
const depositInstructionsModal = document.getElementById('deposit-instructions-modal');
const tonTransferLink = document.getElementById('ton-transfer-link');
const confirmPaymentSentButton = document.getElementById('confirm-payment-sent-button');
const cancelDepositButton = document.getElementById('cancel-deposit-button');
const depositExpiryInfo = document.getElementById('deposit-expiry-info');
const depositStatusMessageEl = document.getElementById('deposit-status-message');
const depositLoader = document.getElementById('deposit-loader');

const VISUAL_ITEMS_PER_REEL_INITIAL = 10; // Number of items to initially populate each reel
const VISUAL_ITEMS_PER_REEL_SPIN_BUFFER = 70; // Additional items appended for the spin to ensure enough length
let currentPendingDepositId = null;
let depositExpiryInterval = null;
let depositRecipientAddressRaw = '';
let depositCommentText = '';

const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
    manifestUrl: 'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/tonconnect-manifest.json',
    buttonRootId: 'ton-connect-button'
});
let tgBackButton = null;
const backButtonHandlerStack = [];

let dataFetchedSuccessfully = false;
let tonConnectWalletInfo = null;


// Utility Functions
function _updateTgBackButton() {
    if (!tgBackButton) return;
    if (backButtonHandlerStack.length > 0) {
        const handler = backButtonHandlerStack[backButtonHandlerStack.length - 1];
        tgBackButton.offClick();
        tgBackButton.onClick(handler);
        tgBackButton.show();
    } else {
        tgBackButton.hide();
        tgBackButton.offClick();
    }
}
function pushTgBackButtonHandler(handler) {
    if (!tgBackButton) return;
    backButtonHandlerStack.push(handler);
    _updateTgBackButton();
}
function popTgBackButtonHandler() {
    if (!tgBackButton) return;
    if (backButtonHandlerStack.length > 0) backButtonHandlerStack.pop();
    _updateTgBackButton();
}
function clearTgBackButtonStack() {
    if (!tgBackButton) return;
    backButtonHandlerStack.length = 0;
    _updateTgBackButton();
}
function navigateBackToMainPage() {
    navigateToPage('main-page');
}
function closeRouletteModalWithBackButton() {
    closeRouletteModal();
}
function closeWinOverlayModalWithBackButton() {
    closeWinOverlayModal();
}
function closeDepositModalWithBackButton() {
    closeDepositInstructionsModal();
}

function updateLoadingStatus(message) {
    if (loadingStatusText) {
        loadingStatusText.textContent = message;
    }
}
    
async function apiRequest(endpoint, method = 'GET', body = null) {
    const headers = { 'Content-Type': 'application/json' };
    if (Telegram.WebApp.initData) headers['X-Telegram-Init-Data'] = Telegram.WebApp.initData;
    const config = { method, headers };
    if (body && (method === 'POST' || method === 'PUT')) config.body = JSON.stringify(body);
    try {
        const response = await fetch(API_BASE_URL + endpoint, config);
        if (!response.ok) {
            let errData; try { errData = await response.json(); } catch (e) { errData = { error: `HTTP ${response.status}: ${response.statusText}` }; }
            showTGNotification(errData.error || errData.message || `Request failed`, 'error');
            throw new Error(errData.error || errData.message);
        }
        return response.status === 204 ? null : await response.json();
    } catch (error) {
        if (!(error.message.includes("HTTP") || error.message.includes("Request failed"))) {
            showTGNotification(`Network: ${error.message}`, 'error');
        }
        throw error;
    }
}

function updateBalances() {
    headerElements.tonBalanceSpan.textContent = `${currentUser.tonBalance.toFixed(2)}`;
    profileElements.balanceDisplay.innerHTML = `${currentUser.tonBalance.toFixed(2)} TON`;
}

function navigateToPage(pageId) {
    pages.forEach(p => p.classList.remove('active'));
    document.getElementById(pageId)?.classList.add('active');
    appNavButtons.forEach(b => b.classList.toggle('active', b.dataset.page === pageId));
    if (tgBackButton) {
        if (pageId === 'main-page') {
            clearTgBackButtonStack();
        } else {
            while (backButtonHandlerStack.length > 0 && backButtonHandlerStack[backButtonHandlerStack.length - 1] !== navigateBackToMainPage) {
                popTgBackButtonHandler();
            }
            if (backButtonHandlerStack.length === 0) {
                pushTgBackButtonHandler(navigateBackToMainPage);
            }
        }
    }
    window.scrollTo(0, 0);
}

function showTGNotification(message, type = 'info') {
    Telegram.WebApp.showAlert?.(message);
    if (Telegram.WebApp.HapticFeedback) {
        if (type === 'success') Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        else if (type === 'error') Telegram.WebApp.HapticFeedback.notificationOccurred('error');
        else if (type === 'warning') Telegram.WebApp.HapticFeedback.notificationOccurred('warning');
    }
}

function renderHeader() {
    updateBalances();
}

function updateUIBasedOnWallet(wallet) {
    tonConnectWalletInfo = wallet;
    const connected = !!wallet;

    if (connected) {
        const addr = wallet.account.address;
        currentUser.walletAddressRaw = addr;
        const friendlyAddr = TonConnectSDK.toUserFriendlyAddress(addr, wallet.account.chain === TonConnectSDK.CHAIN.TESTNET);
        currentUser.walletAddress = friendlyAddr;
        headerElements.walletAddressDisplay.textContent = `${friendlyAddr.substring(0, 5)}...${friendlyAddr.substring(friendlyAddr.length - 4)}`;
        headerElements.walletAddressDisplay.classList.add('connected');
        headerElements.walletAddressDisplay.style.display = 'block';
        headerElements.balanceDisplay.classList.add('connected');
        headerElements.balanceDisplay.style.display = 'flex';
        headerElements.tonConnectButton.style.display = 'none';
        profileElements.walletAddress.textContent = friendlyAddr;
        profileElements.disconnectWalletButton.style.display = 'block';
    } else {
        currentUser.walletAddress = null;
        currentUser.walletAddressRaw = null;
        headerElements.walletAddressDisplay.classList.remove('connected');
        headerElements.walletAddressDisplay.style.display = 'none';
        headerElements.balanceDisplay.classList.remove('connected');
        headerElements.balanceDisplay.style.display = 'none';
        headerElements.tonConnectButton.style.display = 'block';
        profileElements.walletAddress.textContent = 'Not Connected';
        profileElements.disconnectWalletButton.style.display = 'none';
    }

    if (dataFetchedSuccessfully) {
        updateBalances();
        renderProfile(); // Also calls renderInventory which depends on currentUser.inventory
    } else {
        headerElements.tonBalanceSpan.textContent = `0.00`;
        profileElements.balanceDisplay.innerHTML = `0.00 TON`;
    }
}

function renderCasesAndSlots() {
    renderCases();
}

function renderCases() {
    casesGrid.innerHTML = '';
    if (!casesData || casesData.length === 0) {
        casesGrid.innerHTML = "<p>Loading cases...</p>";
        return;
    }
    casesData.forEach(caseItem => {
        const card = document.createElement('div');
        card.className = 'case-card';
        card.dataset.caseId = caseItem.id;
        card.onclick = () => openRouletteModal(caseItem);
        const imgCont = document.createElement('div');
        imgCont.className = 'case-image-display';
        const img = document.createElement('img');
        img.loading = 'lazy';
        img.alt = caseItem.name;
        img.onerror = () => { imgCont.textContent = '❓'; imgCont.style.cssText = 'font-size:2.5em;display:flex;align-items:center;justify-content:center;color:var(--text-secondary);'; };
        img.src = generateImageFilename(caseItem.imageFilename || caseItem.name);
        imgCont.appendChild(img);
        const priceEl = document.createElement('div');
        priceEl.className = 'case-price';
        priceEl.textContent = `${parseFloat(caseItem.priceTON).toFixed(1)} TON`;
        card.append(imgCont, priceEl);
        casesGrid.appendChild(card);
    });
}

function renderProfile() {
    // Clear any previous content in the avatar placeholder
    profileElements.avatar.innerHTML = ''; 

    if (currentUser.photo_url) {
        const img = document.createElement('img');
        img.src = currentUser.photo_url;
        img.alt = currentUser.first_name ? `${currentUser.first_name}'s avatar` : 'User Avatar';
        img.style.width = '100%'; // Make image fill the placeholder
        img.style.height = '100%';
        img.style.objectFit = 'cover'; // Cover the area without distortion
        img.style.borderRadius = 'inherit'; // Inherit border-radius from parent
        profileElements.avatar.appendChild(img);
    } else {
        // Fallback to text initial if no photo URL is available
        profileElements.avatar.textContent = currentUser.first_name ? currentUser.first_name.charAt(0).toUpperCase() : '?';
    }

    profileElements.username.textContent = (currentUser.first_name || currentUser.last_name) ? `${currentUser.first_name || ''} ${currentUser.last_name || ''}`.trim() : currentUser.username || 'User';
    profileElements.userid.textContent = currentUser.id ? `#${currentUser.id}` : '#...';
    profileElements.walletAddress.textContent = currentUser.walletAddress || 'Not Connected';
    profileElements.disconnectWalletButton.style.display = currentUser.walletAddress ? 'block' : 'none';
    renderInventory();
}

function renderInventory() {
    profileElements.inventoryGrid.innerHTML = '';
    let totalValue = 0;
    if (currentUser.inventory.length === 0) {
        profileElements.emptyInventoryMessage.style.display = 'block';
        profileElements.sellAllButton.style.display = 'none';
    } else {
        profileElements.emptyInventoryMessage.style.display = 'none';
        currentUser.inventory.forEach(item => {
            totalValue += item.currentValue || 0;
            const itemDiv = document.createElement('div');
            itemDiv.className = 'inventory-item';
            const imgCont = document.createElement('div');
            imgCont.className = 'item-image-display';
            const img = document.createElement('img');
            img.src = generateImageFilename(item.imageFilename || item.name);
            img.alt = item.name;
            img.loading = 'lazy';
            imgCont.appendChild(img);
            itemDiv.innerHTML = `<div class="inventory-item-name" title="${item.name}">${item.name}</div><div class="inventory-item-value">${(item.currentValue || 0).toFixed(2)} TON</div><div class="inventory-item-actions">${item.is_ton_prize ? '<span style="font-size:0.8em; color:var(--success-color);">TON Prize</span>' : `<button class="button button-secondary withdraw-button" onclick="startWithdrawalProcess(${item.id})">Withdraw</button><button class="button button-secondary" onclick="handleSingleConvert(${item.id})">Convert</button>`}</div>`;
            itemDiv.insertBefore(imgCont, itemDiv.firstChild);
            profileElements.inventoryGrid.appendChild(itemDiv);
        });
        profileElements.sellAllButton.style.display = 'block';
        profileElements.sellAllValueSpan.textContent = totalValue.toFixed(2);
    }
    profileElements.inventoryCount.textContent = currentUser.inventory.length;
}

async function renderLeaderboard() {
    try {
        const leaders = await apiRequest('/api/get_leaderboard');
        leaderboardList.innerHTML = '';
        leaders.forEach(l => {
            const entry = document.createElement('div');
            entry.className = 'leader-entry';
            if (l.user_id === currentUser.id) entry.classList.add('current-user-entry');
            entry.innerHTML = `<div class="rank">${l.rank}</div><div class="avatar-placeholder">${l.avatarChar}</div><div class="info"><div class="name">${l.name}</div><div class="details">User ID: ${String(l.user_id).slice(0, 6)}...</div></div><div class="score">${l.income.toFixed(2)} TON</div>`;
            leaderboardList.appendChild(entry);
        });
    } catch (e) {
        leaderboardList.innerHTML = '<p style="text-align:center;color:var(--text-placeholder);padding:20px;">Could not load leaders.</p>';
    }
}

function renderInvitePage() {
    inviteElements.referralLink.value = currentUser.referralCode ? `https://t.me/${BOT_USERNAME}/${MINI_APP_NAME}?startapp=${currentUser.referralCode}` : 'Loading...';
    inviteElements.referralBalance.innerHTML = `${currentUser.referralEarningsPending.toFixed(2)} TON`;
    inviteElements.invitedCount.textContent = currentUser.invited_friends_count || 0;
}

function showWinOverlay(wonPrizesArray) {
    lastWonPrizesForOverlay = wonPrizesArray;
    winOverlayPrizeImageContainer.innerHTML = '';
    winOverlayPrizeDetailsEl.innerHTML = '';
    if (wonPrizesArray.length === 1) {
        const prizeItem = wonPrizesArray[0];
        const img = document.createElement('img');
        img.src = generateImageFilename(prizeItem.imageFilename || prizeItem.name);
        img.alt = prizeItem.name;
        winOverlayPrizeImageContainer.appendChild(img);
        winOverlayNameEl.textContent = `You Won: ${prizeItem.name}!`;
        winOverlayConvertBtn.style.display = prizeItem.is_ton_prize ? 'none' : 'block';
        if (!prizeItem.is_ton_prize) {
            winOverlayConvertValue.textContent = (prizeItem.currentValue || 0).toFixed(2);
            winOverlayConvertBtn.childNodes[0].nodeValue = "Convert to ";
        }
    } else if (wonPrizesArray.length > 1) {
        winOverlayNameEl.textContent = `You Won ${wonPrizesArray.length} Items!`;
        let totalConvertValue = 0;
        let canConvertAny = false;
        let prizeNamesHTML = '';
        wonPrizesArray.forEach(prizeItem => {
            const img = document.createElement('img');
            img.src = generateImageFilename(prizeItem.imageFilename || prizeItem.name);
            img.alt = prizeItem.name;
            winOverlayPrizeImageContainer.appendChild(img);
            prizeNamesHTML += `<div>- ${prizeItem.name} (${(prizeItem.currentValue || 0).toFixed(2)} TON)</div>`;
            if (!prizeItem.is_ton_prize) {
                totalConvertValue += (prizeItem.currentValue || 0);
                canConvertAny = true;
            }
        });
        winOverlayPrizeDetailsEl.innerHTML = prizeNamesHTML;
        winOverlayConvertBtn.style.display = canConvertAny ? 'block' : 'none';
        if (canConvertAny) {
            winOverlayConvertValue.textContent = totalConvertValue.toFixed(2);
            winOverlayConvertBtn.childNodes[0].nodeValue = "Convert All to ";
        }
    }
    winOverlayModal.classList.add('active');
    if (tgBackButton) pushTgBackButtonHandler(closeWinOverlayModalWithBackButton);
    Telegram.WebApp.HapticFeedback?.notificationOccurred('success');
}

function closeWinOverlayModal() {
    if (tgBackButton) popTgBackButtonHandler();
    winOverlayModal.classList.remove('active');
    lastWonPrizesForOverlay = [];
}

// MODIFIED initializeRouletteVisuals FUNCTION
function initializeRouletteVisuals(caseItem, multiplier) {
    const allReelContainers = [rouletteReel1, rouletteReel2, rouletteReel3];
    // We assume roulette-item height is fixed for initial calc. Get from CSS if needed.
    const itemHeight = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--roulette-item-height').replace('px', '')) || 80; 
    const rouletteRowVisibleHeight = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--single-roulette-row-visual-height').replace('px', '')) || 260; // Assuming this is set up
    
    // Hide all reels initially
    allReelContainers.forEach(container => container.classList.remove('active'));

    // Determine available prizes, with a fallback for empty cases
    let availablePrizes = caseItem && caseItem.prizes && caseItem.prizes.length > 0 ? caseItem.prizes : [{ name: "Loading...", imageFilename: "placeholder.png", is_ton_prize: false, floor_price: 0 }];

    // Show and populate only the necessary number of reels
    for (let i = 0; i < multiplier; i++) {
        const reelContainer = allReelContainers[i];
        if (reelContainer) {
            reelContainer.classList.add('active'); // Make this reel visible
            const spinnerReel = reelContainer.querySelector('.roulette-spinner-reel');
            spinnerReel.innerHTML = ''; // Clear existing items when a case is opened/multiplier changed

            let defaultVisualItemsData = [];
            // Populate with initial items to make it look ready
            for (let j = 0; j < VISUAL_ITEMS_PER_REEL_INITIAL; j++) {
                const randomPrize = availablePrizes[Math.floor(Math.random() * availablePrizes.length)];
                defaultVisualItemsData.push(randomPrize);
            }
            
            // Append visual items to the reel
            defaultVisualItemsData.forEach(pData => {
                const itemEl = document.createElement('div');
                itemEl.className = 'roulette-item';
                const img = document.createElement('img');
                img.src = generateImageFilename(pData.imageFilename || pData.name);
                img.alt = pData.name;
                itemEl.appendChild(img);
                // Store full prize data on the element for later inspection (e.g., floorPrice for nudging)
                itemEl.dataset.prizeData = JSON.stringify({
                    name: pData.name, imageFilename: pData.imageFilename,
                    is_ton_prize: pData.is_ton_prize, floorPrice: pData.floor_price, value: pData.value 
                });
                spinnerReel.appendChild(itemEl);
            });

            // Set initial reel position to center one of the items
            // This makes it look like it's already "on" something without needing to spin.
            spinnerReel.style.transition = 'none'; // Ensure no transition on initial load
            const middleItemIndex = Math.floor(VISUAL_ITEMS_PER_REEL_INITIAL / 2);
            // Calculate offset to bring the middle of the middle item to the center of the visible roulette area
            const initialScrollOffset = (middleItemIndex * itemHeight) + (itemHeight / 2) - (rouletteRowVisibleHeight / 2);
            spinnerReel.style.top = `-${initialScrollOffset}px`;
            void spinnerReel.offsetWidth; // Force reflow
        }
    }
}

function openRouletteModal(caseItem) {
    currentOpenCaseOrSlot = caseItem;
    selectedCaseMultiplier = 1; // Default to 1x when opening
    updateCaseMultiplierButtons(); // This will call initializeRouletteVisuals with 1x
    rouletteCaseName.textContent = caseItem.name;
    updateSpinButtonText();

    possiblePrizesDisplay.innerHTML = '';
    const prizeMap = new Map();

    // Iterate through prizes in the selected case
    caseItem.prizes.forEach(p => {
        if (!p || !p.name) return;

        const prizeName = p.name; // Get the name of the prize
        // Look up the floor price from the global UPDATED_FLOOR_PRICES_FRONTEND map
        const floorPrice = UPDATED_FLOOR_PRICES_FRONTEND[prizeName] || 0; // Default to 0 if not found

        // Create a new prize data object for the map, including the looked-up floorPrice
        const pDataWithPrice = {
            name: prizeName,
            probability: p.probability, // Keep probability as it's part of the raw data
            imageFilename: p.imageFilename || generateImageFilename(prizeName), // Use imageFilename from data or generate
            floorPrice: floorPrice // Explicitly add the looked-up floor price
        };

        // Aggregate prizes by name (if there are duplicates or for consistent display)
        if (prizeMap.has(prizeName)) {
            // If you need to combine probabilities or other stats for identical prizes, do it here
            // For now, if a name already exists, we'll just ensure its floorPrice is consistent.
            // (In our current setup, prize names within one case are unique, so this mainly handles Kissed Frog variants properly)
            const existing = prizeMap.get(prizeName);
            prizeMap.set(prizeName, {
                ...existing,
                probability: (existing.probability || 0) + (p.probability || 0),
                floorPrice: floorPrice // Ensure the correct floor price is set
            });
        } else {
            prizeMap.set(prizeName, pDataWithPrice);
        }
    });

    // Now iterate through the aggregated prizeMap to display the cards
    prizeMap.forEach((pData, name) => {
        const displayPrice = pData.floorPrice || 0; // Use the floorPrice from pData
        const card = document.createElement('div');
        card.className = 'prize-card';

        const imgCont = document.createElement('div');
        imgCont.className = 'prize-card-image-placeholder';
        const img = document.createElement('img');
        img.src = pData.imageFilename; // Use the imageFilename now present in pData
        img.alt = name;
        imgCont.appendChild(img);

        // Display the floor price in TON
        card.innerHTML = `<span class="prize-card-price">${displayPrice.toFixed(2)} TON</span><span class="prize-card-name">${name}</span>`;
        
        card.insertBefore(imgCont, card.firstChild);
        possiblePrizesDisplay.appendChild(card);
    });

    rouletteModal.classList.add('active');
    if (tgBackButton) pushTgBackButtonHandler(closeRouletteModalWithBackButton);
    Telegram.WebApp.HapticFeedback?.impactOccurred('light');
}

function updateSpinButtonText() {
    if (currentOpenCaseOrSlot && currentOpenCaseOrSlot.priceTON) {
        const totalPrice = parseFloat(currentOpenCaseOrSlot.priceTON) * selectedCaseMultiplier;
        spinButton.textContent = `Spin ${selectedCaseMultiplier}x (${totalPrice.toFixed(1)} TON)`;
    }
}

function updateCaseMultiplierButtons() {
    caseMultiplierSelector.querySelectorAll('button').forEach(btn => {
        btn.classList.toggle('active-multiplier', parseInt(btn.dataset.multiplier) === selectedCaseMultiplier);
        if (parseInt(btn.dataset.multiplier) === selectedCaseMultiplier) btn.classList.remove('button-secondary');
        else btn.classList.add('button-secondary');
    }); 
    // Re-initialize visuals based on the NEW selected multiplier
    initializeRouletteVisuals(currentOpenCaseOrSlot, selectedCaseMultiplier);
}

function closeRouletteModal() {
    if (tgBackButton) popTgBackButtonHandler();
    rouletteModal.classList.remove('active');
    currentOpenCaseOrSlot = null;
    if (spinAnimationTimeoutOuter) clearTimeout(spinAnimationTimeoutOuter);
    // Ensure all reels are hidden when closing the modal
    const allReelContainers = [rouletteReel1, rouletteReel2, rouletteReel3];
    allReelContainers.forEach(container => container.classList.remove('active'));
}

function getItemValue(prizeObject) {
    if (prizeObject.is_ton_prize) {
        return prizeObject.currentValue || prizeObject.value || 0; // Use 'value' for TON prizes
    }
    // For NFT items, prizeObject should already have floorPrice from `caseItem.prizes`
    return prizeObject.floorPrice || prizeObject.currentValue || 0; 
}
    
// MODIFIED spinRoulette FUNCTION
async function spinRoulette() {
    if (!currentOpenCaseOrSlot) return;
    spinButton.disabled = true;
    spinButton.textContent = 'Spinning...';
    Telegram.WebApp.HapticFeedback?.impactOccurred('light');

    const allReelContainers = [rouletteReel1, rouletteReel2, rouletteReel3];
    const activeSpinners = allReelContainers
                                .filter(container => container.classList.contains('active'))
                                .map(container => container.querySelector('.roulette-spinner-reel'));
    
    if (activeSpinners.length === 0) {
        showTGNotification("No active reels to spin. Please select a multiplier.", "error");
        spinButton.disabled = false;
        updateSpinButtonText();
        return;
    }

    const availablePrizes = currentOpenCaseOrSlot.prizes; 
    
    // Dynamically get item height and visible reel height (they might change or be affected by padding)
    const itemHeight = activeSpinners[0].querySelector('.roulette-item').offsetHeight;
    const rouletteRowVisibleHeight = activeSpinners[0].parentElement.clientHeight;
    const centerOffset = (rouletteRowVisibleHeight / 2); // Center of the visible window for the payline

    // Prepare reels for spin: Append buffer items and winning item
    activeSpinners.forEach((spinnerReel, reelIndex) => {
        // Remove existing transitions to prevent flicker when appending
        spinnerReel.style.transition = 'none'; 
        void spinnerReel.offsetWidth; // Force reflow

        // Append a buffer of random items to make the spin visually longer
        for (let j = 0; j < VISUAL_ITEMS_PER_REEL_SPIN_BUFFER; j++) {
            const randomPrize = availablePrizes[Math.floor(Math.random() * availablePrizes.length)];
            const itemEl = document.createElement('div');
            itemEl.className = 'roulette-item';
            const img = document.createElement('img');
            img.src = generateImageFilename(randomPrize.imageFilename || randomPrize.name);
            img.alt = randomPrize.name;
            itemEl.appendChild(img);
            itemEl.dataset.prizeData = JSON.stringify({
                name: randomPrize.name, imageFilename: randomPrize.imageFilename,
                is_ton_prize: randomPrize.is_ton_prize, floorPrice: randomPrize.floor_price, value: randomPrize.value
            });
            spinnerReel.appendChild(itemEl);
        }
    });

    try {
        const result = await apiRequest('/api/open_case', 'POST', { case_id: currentOpenCaseOrSlot.id, multiplier: selectedCaseMultiplier });
        
        spinButton.disabled = false;
        updateSpinButtonText();

        if (result.status === 'success' && result.won_prizes && result.won_prizes.length > 0) {
            currentUser.tonBalance = result.new_balance_ton;
            updateBalances();

            if (spinAnimationTimeoutOuter) clearTimeout(spinAnimationTimeoutOuter);

            activeSpinners.forEach((spinnerReel, index) => {
                let currentReelItemsDOMElements = Array.from(spinnerReel.children);
                const actualWonPrizeBackendData = result.won_prizes[index] || 
                                                  (index === 0 && result.won_prizes[0]); // Fallback for single win

                if (!actualWonPrizeBackendData) {
                    console.warn(`No won prize data for reel ${index}. Skipping animation for this reel.`);
                    return; 
                }

                // --- 1. Place the actual winning prize at a determined "landing zone"
                // The winning item will land at the end of the initial items + a buffer offset
                // This ensures it appears after the initial set, but not at the very end of the *newly added* buffer
                const landingSpotIndex = VISUAL_ITEMS_PER_REEL_INITIAL + Math.floor(VISUAL_ITEMS_PER_REEL_SPIN_BUFFER / 2); 

                if (currentReelItemsDOMElements[landingSpotIndex]) {
                    const targetEl = currentReelItemsDOMElements[landingSpotIndex];
                    const imgElement = targetEl.querySelector('img');
                    imgElement.src = generateImageFilename(actualWonPrizeBackendData.imageFilename || actualWonPrizeBackendData.name);
                    imgElement.alt = actualWonPrizeBackendData.name;
                    targetEl.dataset.isWinner = 'true';
                    targetEl.dataset.prizeData = JSON.stringify(actualWonPrizeBackendData);
                } else {
                    console.warn(`Could not place winning item at target index ${landingSpotIndex}. Reel may be too short or index is off.`);
                }

                // --- 2. Calculate base scroll distance to center the winning item
                let scrollDist = (landingSpotIndex * itemHeight) + (itemHeight / 2) - centerOffset;

                // --- 3. Add a random visual bias within the winning item's height
                const randomBiasRange = itemHeight * 0.4; // Up to 40% of item height deviation from center
                let visualBiasOffsetPx = (Math.random() * randomBiasRange) - (randomBiasRange / 2); // Random value between -range/2 and +range/2
                scrollDist += visualBiasOffsetPx;

                // --- 4. Implement Nudge towards more expensive nearby items
                const nudgeRange = 3; // Check 3 items above and 3 items below
                const winningItemValue = getItemValue(actualWonPrizeBackendData);
                let nudgeValueThreshold = winningItemValue * 1.5; // Nudge towards items 1.5x more expensive

                let bestNudgeCandidate = null;
                let maxNudgeAmount = itemHeight * 0.4; // Max nudge amount within the item
                
                // Scan for expensive items above and below the winning item
                for (let j = 1; j <= nudgeRange; j++) {
                    const idxAbove = landingSpotIndex - j;
                    const idxBelow = landingSpotIndex + j;

                    // Check item above
                    if (idxAbove >= 0 && currentReelItemsDOMElements[idxAbove]) {
                        try {
                            const itemAboveData = JSON.parse(currentReelItemsDOMElements[idxAbove].dataset.prizeData);
                            const itemAboveValue = getItemValue(itemAboveData);
                            if (itemAboveValue > nudgeValueThreshold && (!bestNudgeCandidate || itemAboveValue > getItemValue(JSON.parse(bestNudgeCandidate.item.dataset.prizeData)))) {
                                bestNudgeCandidate = { item: currentReelItemsDOMElements[idxAbove], direction: 'above', distance: j };
                            }
                        } catch (e) { /* ignore parse errors for robustness */ }
                    }

                    // Check item below
                    if (idxBelow < currentReelItemsDOMElements.length && currentReelItemsDOMElements[idxBelow]) {
                        try {
                            const itemBelowData = JSON.parse(currentReelItemsDOMElements[idxBelow].dataset.prizeData);
                            const itemBelowValue = getItemValue(itemBelowData);
                            if (itemBelowValue > nudgeValueThreshold && (!bestNudgeCandidate || itemBelowValue > getItemValue(JSON.parse(bestNudgeCandidate.item.dataset.prizeData)))) {
                                bestNudgeCandidate = { item: currentReelItemsDOMElements[idxBelow], direction: 'below', distance: j };
                            }
                        } catch (e) { /* ignore parse errors for robustness */ }
                    }
                }

                // Apply the nudge
                if (bestNudgeCandidate) {
                    let nudgeMagnitude = maxNudgeAmount * (1 / (bestNudgeCandidate.distance + 1)); // Closer items nudge more
                    nudgeMagnitude = Math.min(nudgeMagnitude, maxNudgeAmount); // Clamp to max nudge

                    if (bestNudgeCandidate.direction === 'above') {
                        // Move reel UP (scrollDist decreases), payline lands lower on winner (closer to item above)
                        scrollDist -= nudgeMagnitude; 
                        console.log(`Nudging reel ${index} up by ${nudgeMagnitude.toFixed(2)}px towards ${JSON.parse(bestNudgeCandidate.item.dataset.prizeData).name} (value ${getItemValue(JSON.parse(bestNudgeCandidate.item.dataset.prizeData))})`);
                    } else { // 'below'
                        // Move reel DOWN (scrollDist increases), payline lands higher on winner (closer to item below)
                        scrollDist += nudgeMagnitude; 
                        console.log(`Nudging reel ${index} down by ${nudgeMagnitude.toFixed(2)}px towards ${JSON.parse(bestNudgeCandidate.item.dataset.prizeData).name} (value ${getItemValue(JSON.parse(bestNudgeCandidate.item.dataset.prizeData))})`);
                    }
                }

                // --- 5. Clamp the final scroll position to ensure payline stays within the winning item
                const minScrollPosForWinner = (landingSpotIndex * itemHeight) + (itemHeight * 0.1) - centerOffset; // 10% from top of item
                const maxScrollPosForWinner = (landingSpotIndex * itemHeight) + (itemHeight * 0.9) - centerOffset; // 90% from top of item
                scrollDist = Math.max(minScrollPosForWinner, Math.min(maxScrollPosForWinner, scrollDist));

                // Apply animation
                spinnerReel.style.transition = `top 6s cubic-bezier(0.25, 0.1, 0.2, 1)`; // Slower, smoother ease-out
                spinnerReel.style.top = `-${scrollDist}px`;
            });

            const animationDuration = 6000;
            spinAnimationTimeoutOuter = setTimeout(() => {
                // Update user inventory with ALL won prizes from the backend
                result.won_prizes.forEach(wp => {
                    const existingItemIndex = currentUser.inventory.findIndex(invItem => invItem.id === wp.id);
                    // Add item only if it's new (and has an ID, to avoid adding TON prizes to inventory list)
                    if (existingItemIndex === -1 && wp.id) { 
                        currentUser.inventory.push({ 
                            id: wp.id, name: wp.name, imageFilename: wp.imageFilename, 
                            currentValue: wp.currentValue, variant: wp.variant, is_ton_prize: wp.is_ton_prize || false 
                        });
                    }
                });
                renderInventory();
                showWinOverlay(result.won_prizes);

                // --- Post-spin cleanup: Trim reels to a manageable size around the visible area ---
                activeSpinners.forEach(spinnerReel => {
                    const currentTop = parseFloat(spinnerReel.style.top.replace('px', ''));
                    // Recalculate itemHeight for robustness, though it should be constant for the same reel
                    const itemHeightCalc = spinnerRereel.querySelector('.roulette-item') ? spinnerReel.querySelector('.roulette-item').offsetHeight : 80;
                    
                    // Estimate the index of the item that is now at the top of the visible window
                    const itemsScrolledPast = Math.floor(Math.abs(currentTop) / itemHeightCalc);
                    
                    // Keep items around the final stopping point for visual continuity
                    // Example: Keep 10 items before the stopped item and (visible items * 2) after
                    const startIndex = Math.max(0, itemsScrolledPast - 10); 
                    const endIndex = Math.min(spinnerReel.children.length, itemsScrolledPast + 10 + Math.ceil(rouletteRowVisibleHeight / itemHeightCalc) * 2);
                    
                    const itemsToKeep = Array.from(spinnerReel.children).slice(startIndex, endIndex);
                    
                    spinnerReel.innerHTML = ''; // Clear and re-populate with trimmed list
                    itemsToKeep.forEach(itemEl => spinnerReel.appendChild(itemEl));

                    spinnerReel.style.transition = 'none'; 
                    // Adjust top position to account for removed items
                    spinnerReel.style.top = `${currentTop + (startIndex * itemHeightCalc)}px`;
                    void spinnerReel.offsetWidth; // Force reflow
                });

            }, animationDuration + 100);

        } else {
            showTGNotification(result.error || result.message || 'Failed to open case.', 'error');
        }
    } catch (e) {
        console.error("Spin roulette error", e);
        spinButton.disabled = false;
        updateSpinButtonText();
        showTGNotification("Error during spin. Please try again.", "error");
    }
}
    
async function handleSingleConvert(itemId) {
    const success = await convertItemToTon(itemId);
    if (success) {
        showTGNotification("Item converted to TON!", 'success');
        updateBalances();
        renderInventory();
    }
}

async function convertItemToTon(itemId) {
    const itemInInventory = currentUser.inventory.find(i => i.id === itemId);
    if (itemInInventory && itemInInventory.is_ton_prize) {
        showTGNotification("Cannot convert TON prize.", "info");
        return false;
    }
    try {
        const res = await apiRequest('/api/convert_to_ton', 'POST', { inventory_item_id: parseInt(itemId) });
        if (res.status === 'success') {
            currentUser.tonBalance = res.new_balance_ton;
            currentUser.inventory = currentUser.inventory.filter(i => i.id !== parseInt(itemId));
            return true;
        } else {
            showTGNotification(res.error || res.message || 'Failed.', 'error');
            return false;
        }
    } catch (e) {
        showTGNotification("Conversion request failed.", "error");
        return false;
    }
}

async function handleConvertAll() {
    if (lastWonPrizesForOverlay.length === 0) {
        showTGNotification("No items to convert.", "warning");
        return;
    }
    let successCount = 0;
    let failCount = 0;
    const itemsToConvert = lastWonPrizesForOverlay.filter(p => !p.is_ton_prize && p.id);
    if (itemsToConvert.length === 0) {
        showTGNotification("No convertible items in this win.", "info");
        closeWinOverlayModal();
        return;
    }
    for (const item of itemsToConvert) {
        const success = await convertItemToTon(item.id);
        if (success) successCount++;
        else failCount++;
    }
    updateBalances();
    renderInventory();
    if (failCount > 0) showTGNotification(`${successCount} item(s) converted. ${failCount} failed.`, 'warning');
    else showTGNotification(`${successCount} item(s) converted to TON!`, 'success');
    closeWinOverlayModal();
}

async function handleUpgrade() { // Renamed from original `handleUpgrade` in provided code snippet
    if (!selectedItemForUpgrade || !desiredItemForUpgrade) {
        showTGNotification("Please select both your item and the desired item.", 'warning');
        return;
    }

    upgradePageElements.doUpgradeButton.disabled = true;
    upgradePageElements.doUpgradeButton.textContent = "Upgrading...";
    Telegram.WebApp.HapticFeedback?.impactOccurred('medium');

    try {
        // The backend will use selectedItemForUpgrade.id and desiredItemForUpgrade.name
        // It will also recalculate multiplier and chance for security.
        const res = await apiRequest('/api/upgrade_item_v2', 'POST', { 
            inventory_item_id: selectedItemForUpgrade.id,
            desired_item_name: desiredItemForUpgrade.name 
            // Backend will fetch floor prices and calculate actual X and chance
        });

        await startUpgradeAnimation(res.status === 'success');
        
        if (res.status === 'success') {
            const upgradedItemData = res.item; // Backend returns the new item
            currentUser.inventory = currentUser.inventory.filter(i => i.id !== selectedItemForUpgrade.id);
            currentUser.inventory.push(upgradedItemData);
            
            showUpgradeResultModal(true, selectedItemForUpgrade, upgradedItemData);
        } else {
            if (res.item_lost) { // If backend confirms item was lost
                currentUser.inventory = currentUser.inventory.filter(i => i.id !== selectedItemForUpgrade.id);
            }
            showUpgradeResultModal(false, selectedItemForUpgrade, null);
        }
        
        renderInventory(); // Update inventory list in profile
        updateBalances(); // Balances might change if backend adjusts total_won_ton

    } catch (e) {
        console.error("Upgrade error:", e);
        showTGNotification("An error occurred during upgrade. Please try again.", "error");
        // Reset UI if error before animation
        upgradePageElements.chancePointer.classList.remove('spinning');
        upgradePageElements.chancePointer.style.transform = `translateX(-50%) rotate(0deg)`;
    } finally {
        upgradePageElements.doUpgradeButton.disabled = false; // Re-enable button after modal is closed (or here if modal handles its own lifecycle)
        // Text reset will happen when modal is closed or new items selected
    }
}

async function sellAllItems() {
    const sellableItems = currentUser.inventory.filter(i => !i.is_ton_prize);
    if (!sellableItems.length) {
        showTGNotification("No sellable items.", "info");
        return;
    }
    const val = parseFloat(profileElements.sellAllValueSpan.textContent);
    if (Telegram.WebApp.showConfirm) {
        Telegram.WebApp.showConfirm(`Sell all non-TON items for ~${val.toFixed(2)} TON?`, async (ok) => {
            if (ok) doSellAll();
        });
    } else if (confirm(`Sell all non-TON items for ~${val.toFixed(2)} TON?`)) {
        doSellAll();
    }
}

async function doSellAll() {
    try {
        const res = await apiRequest('/api/sell_all_items', 'POST');
        if (res.status === 'success') {
            currentUser.tonBalance = res.new_balance_ton;
            currentUser.inventory = currentUser.inventory.filter(i => i.is_ton_prize);
            updateBalances();
            renderInventory();
            showTGNotification(res.message, "success");
        } else showTGNotification(res.message || "Failed.", "error");
    } catch (e) {
        showTGNotification("Sell all request failed.", "error");
    }
}

function showWithdrawStep(step) {
    withdrawSteps.forEach((s, i) => s.classList.toggle('active', i + 1 === step));
}

function startWithdrawalProcess(inventoryItemId) {
    const item = currentUser.inventory.find(i => i.id === parseInt(inventoryItemId));
    if (!item || item.is_ton_prize) {
        showTGNotification("Item not found or not withdrawable.", "error");
        return;
    }
    itemToWithdraw = inventoryItemId;
    withdrawModal.querySelector('h3').textContent = `Withdraw ${item.name}`;
    showWithdrawStep(1);
    withdrawModal.classList.add('active');
    if (tgBackButton) pushTgBackButtonHandler(closeWithdrawModalWithBackButton);
}

async function completeChosenGiftWithdrawal() {
    if (!itemToWithdraw || !selectedTonnelGiftDetails) { // itemToWithdraw is inventory_item_id
        showTGNotification("No item or specific gift selected for withdrawal.", "error");
        return;
    }
    showWithdrawStep('step-finalizing');
    withdrawStatusMessage.textContent = "Processing Tonnel withdrawal...";
    withdrawFinalizingLoader.style.display = 'block';

    try {
        // Send inventory_item_id in URL, chosen_tonnel_gift_id in body
        const res = await apiRequest(
            `/api/confirm_tonnel_withdrawal/${itemToWithdraw}`,
            'POST',
            { chosen_tonnel_gift_details: selectedTonnelGiftDetails } // Send all details
        );

        if (res.status === 'success') {
            const idx = currentUser.inventory.findIndex(i => i.id === parseInt(itemToWithdraw));
            if (idx !== -1) currentUser.inventory.splice(idx, 1);
            renderInventory();
            withdrawStatusMessage.textContent = res.message || "Tonnel withdrawal initiated!";
            withdrawStatusMessage.style.color = 'var(--success-color)';
            showTGNotification(res.message || "Tonnel withdrawal initiated!", 'success');
        } else {
            withdrawStatusMessage.textContent = res.message || res.error || "Tonnel withdrawal failed.";
            withdrawStatusMessage.style.color = 'var(--danger-color)';
            showTGNotification(res.message || res.error || "Tonnel withdrawal failed.", 'error');
            // Optionally, allow user to go back to gift selection if purchase fails
            // For now, it stays on finalizing step with error. User can close.
        }
    } catch (e) {
        withdrawStatusMessage.textContent = "Error processing withdrawal.";
        withdrawStatusMessage.style.color = 'var(--danger-color)';
        showTGNotification("Error processing Tonnel withdrawal.", "error");
    } finally {
        withdrawFinalizingLoader.style.display = 'none';
        // Reset for next time
        itemToWithdraw = null;
        selectedTonnelGiftDetails = null;
    }
}

// Close finalizing step
document.getElementById('withdraw-step-finalizing-close').addEventListener('click', closeWithdrawModal);
    
function closeWithdrawModal() {
    if (tgBackButton) popTgBackButtonHandler();
    withdrawModal.classList.remove('active');
    itemToWithdraw = null;
    selectedTonnelGiftDetails = null;
    availableTonnelGifts = [];
    showWithdrawStep('step-1'); // Reset to first step
    withdrawModal.querySelector('h3').textContent = "Withdraw Gift";
    withdrawStatusMessage.textContent = "";
    withdrawFinalizingLoader.style.display = 'none';
    tonnelGiftChoicesGrid.innerHTML = '';
    withdrawStepGiftsConfirmBtn.style.display = 'none';
}

async function initiateDepositProcedure() {
    const amtTxt = profileElements.depositAmountInput.value;
    if (!amtTxt.trim()) {
        showTGNotification("Enter amount.", "warning");
        return;
    }
    const amt = parseFloat(amtTxt);
    if (isNaN(amt) || amt <= 0 || amt < 0.1 || amt > 10000) {
        showTGNotification("Invalid amount. Min 0.1 TON", "error");
        return;
    }
    profileElements.initiateDepositButton.disabled = true;
    profileElements.initiateDepositButton.textContent = "Initializing...";
    try {
        const res = await apiRequest('/api/initiate_deposit', 'POST', { amount: amt });
        profileElements.initiateDepositButton.disabled = false;
        profileElements.initiateDepositButton.textContent = "Deposit TON";
        if (res.status === 'success') {
            currentPendingDepositId = res.pending_deposit_id;
            depositRecipientAddressRaw = res.recipient_address;
            depositCommentText = res.comment;
            const nanoAmt = res.final_amount_nano_ton || Math.round(parseFloat(res.amount_to_send) * 1e9);
            tonTransferLink.href = `ton://transfer/${depositRecipientAddressRaw}?amount=${nanoAmt}&text=${encodeURIComponent(depositCommentText)}`;
            startDepositExpiryTimer(res.expires_at);
            depositStatusMessageEl.textContent = '';
            depositLoader.style.display = 'none';
            confirmPaymentSentButton.disabled = false;
            confirmPaymentSentButton.textContent = 'I Sent Funds';
            depositInstructionsModal.classList.add('active');
            if (tgBackButton) pushTgBackButtonHandler(closeDepositModalWithBackButton);
        } else showTGNotification(res.message || res.error || 'Failed.', 'error');
    } catch (e) {
        profileElements.initiateDepositButton.disabled = false;
        profileElements.initiateDepositButton.textContent = "Deposit TON";
        showTGNotification("Deposit init request failed.", "error");
    }
}

function startDepositExpiryTimer(expiresISO) {
    if (depositExpiryInterval) clearInterval(depositExpiryInterval);
    const expiry = new Date(expiresISO).getTime();
    function update() {
        const now = new Date().getTime();
        const dist = expiry - now;
        if (dist < 0) {
            clearInterval(depositExpiryInterval);
            depositExpiryInfo.textContent = "Expired.";
            confirmPaymentSentButton.disabled = true;
            tonTransferLink.classList.add('button-secondary');
            return;
        }
        const m = Math.floor((dist % (1e3 * 60 * 60)) / (1e3 * 60));
        const s = Math.floor((dist % (1e3 * 60)) / 1e3);
        depositExpiryInfo.textContent = `Expires in ${m}m ${s}s.`;
        tonTransferLink.classList.remove('button-secondary');
    }
    update();
    depositExpiryInterval = setInterval(update, 1e3);
}

async function verifyPaymentSent() {
    if (!currentPendingDepositId) {
        showTGNotification("No deposit.", "error");
        return;
    }
    confirmPaymentSentButton.disabled = true;
    confirmPaymentSentButton.textContent = "Verifying...";
    depositLoader.style.display = 'block';
    depositStatusMessageEl.textContent = 'Checking...';
    try {
        const res = await apiRequest('/api/verify_deposit', 'POST', { pending_deposit_id: currentPendingDepositId });
        if (res.status === 'success') {
            showTGNotification(res.message, 'success');
            currentUser.tonBalance = res.new_balance_ton;
            updateBalances();
            renderProfile();
            closeDepositInstructionsModal();
        } else if (res.status === 'pending') {
            depositStatusMessageEl.textContent = res.message;
            confirmPaymentSentButton.disabled = false;
            confirmPaymentSentButton.textContent = "Check Again";
        } else {
            showTGNotification(res.message || "Failed.", "error");
            depositStatusMessageEl.textContent = res.message || "Failed.";
            if (res.status === 'expired') tonTransferLink.classList.add('button-secondary');
            else {
                confirmPaymentSentButton.disabled = false;
                confirmPaymentSentButton.textContent = "Try Again";
            }
        }
    } catch (e) {
        depositStatusMessageEl.textContent = 'Error verifying.';
        confirmPaymentSentButton.disabled = false;
        confirmPaymentSentButton.textContent = "Try Again";
        showTGNotification("Verification request failed.", "error");
    } finally {
        if (depositLoader.style.display === 'block' && !depositStatusMessageEl.textContent.includes('Checking')) depositLoader.style.display = 'none';
    }
}

function closeDepositInstructionsModal() {
    if (tgBackButton) popTgBackButtonHandler();
    depositInstructionsModal.classList.remove('active');
    if (depositExpiryInterval) clearInterval(depositExpiryInterval);
    currentPendingDepositId = null;
    profileElements.depositAmountInput.value = '';
    tonTransferLink.href = '#';
    depositStatusMessageEl.textContent = '';
    depositLoader.style.display = 'none';
    depositExpiryInfo.textContent = '';
}

async function redeemPromocode() {
    const code = profileElements.promocodeInput.value.trim();
    if (!code) {
        showTGNotification("Enter code.", "warning");
        return;
    }
    profileElements.redeemPromocodeButton.disabled = true;
    try {
        const res = await apiRequest('/api/redeem_promocode', 'POST', { promocode_text: code });
        if (res.status === 'success') {
            currentUser.tonBalance = res.new_balance_ton;
            updateBalances();
            showTGNotification(res.message, 'success');
            profileElements.promocodeInput.value = '';
        } else showTGNotification(res.message || res.error || "Failed.", "error");
    } catch (e) {
        showTGNotification("Promocode request failed.", "error");
    } finally {
        profileElements.redeemPromocodeButton.disabled = false;
    }
}

function populateAllAppGifts() {
    const uniqueGifts = new Map();

    // Collect from casesData
    casesData.forEach(caseItem => {
        caseItem.prizes.forEach(prize => {
            if (prize.name && prize.name !== 'Nothing' && !prize.is_ton_prize) {
                if (!uniqueGifts.has(prize.name)) {
                    uniqueGifts.set(prize.name, {
                        name: prize.name,
                        imageFilename: prize.imageFilename || generateImageFilename(prize.name),
                        floorPrice: UPDATED_FLOOR_PRICES_FRONTEND[prize.name] || 0 // Ensure price from master list
                    });
                }
            }
        });
    });

    // Collect from UPDATED_FLOOR_PRICES_FRONTEND (might have items not in cases)
    for (const name in UPDATED_FLOOR_PRICES_FRONTEND) {
        if (!uniqueGifts.has(name) && name !== 'Nothing') {
             uniqueGifts.set(name, {
                name: name,
                imageFilename: generateImageFilename(name), // Assumes generateImageFilename can handle it
                floorPrice: UPDATED_FLOOR_PRICES_FRONTEND[name]
            });
        }
    }
    
    allAppGiftsForUpgrade = Array.from(uniqueGifts.values()).sort((a,b) => a.floorPrice - b.floorPrice);
    // console.log("All App Gifts for Upgrade:", allAppGiftsForUpgrade);
}
// --- END NEW: Function to populateAllAppGiftsForUpgrade ---


// --- NEW: Functions for New Upgrade UI Logic ---
function openUpgradeItemPicker(type) { // type is 'inventory' or 'desired'
    currentUpgradePickerType = type;
    upgradePageElements.upgradeItemsGrid.innerHTML = '';
    
    if (type === 'inventory') {
        upgradePageElements.upgradePickerTitle.textContent = "Select Your Item from Inventory";
        const userInventoryForUpgrade = currentUser.inventory.filter(item => !item.is_ton_prize && item.currentValue > 0);
        if (userInventoryForUpgrade.length === 0) {
            upgradePageElements.upgradeItemsGrid.innerHTML = '<p style="grid-column: 1/-1; text-align:center; color: var(--text-placeholder);">Your inventory is empty or has no upgradable items.</p>';
        } else {
            userInventoryForUpgrade.forEach(item => {
                const card = createUpgradeableItemCard(item, 'inventory');
                upgradePageElements.upgradeItemsGrid.appendChild(card);
            });
        }
    } else if (type === 'desired') {
        if (!selectedItemForUpgrade) {
            showTGNotification("Please select your item first.", "warning");
            return; // Don't open picker if base item not selected
        }
        upgradePageElements.upgradePickerTitle.textContent = "Select Desired Item";
        const potentialDesiredItems = allAppGiftsForUpgrade.filter(
            gift => gift.floorPrice > selectedItemForUpgrade.currentValue
        );

        if (potentialDesiredItems.length === 0) {
            upgradePageElements.upgradeItemsGrid.innerHTML = '<p style="grid-column: 1/-1; text-align:center; color: var(--text-placeholder);">No items available for upgrade with higher value.</p>';
        } else {
             potentialDesiredItems.forEach(gift => {
                const card = createUpgradeableItemCard(gift, 'desired');
                upgradePageElements.upgradeItemsGrid.appendChild(card);
            });
        }
    }
    upgradePageElements.upgradePickerContainer.style.display = 'block';
}

function closeUpgradeItemPicker() {
    upgradePageElements.upgradePickerContainer.style.display = 'none';
    currentUpgradePickerType = null;
}

function createUpgradeableItemCard(itemData, type) { // itemData for inventory: {id, name, imageFilename, currentValue}, for desired: {name, imageFilename, floorPrice}
    const card = document.createElement('div');
    card.className = 'inventory-item'; // Reuse styling

    const imgCont = document.createElement('div');
    imgCont.className = 'item-image-display';
    const img = document.createElement('img');
    img.src = itemData.imageFilename || generateImageFilename(itemData.name);
    img.alt = itemData.name;
    imgCont.appendChild(img);

    const nameEl = document.createElement('div');
    nameEl.className = 'inventory-item-name';
    nameEl.textContent = itemData.name;

    const valueEl = document.createElement('div');
    valueEl.className = 'inventory-item-value';
    valueEl.textContent = `${(type === 'inventory' ? itemData.currentValue : itemData.floorPrice).toFixed(2)} TON`;
    
    const actionsEl = document.createElement('div');
    actionsEl.className = 'inventory-item-actions';
    const selectBtn = document.createElement('button');
    selectBtn.className = 'button';
    selectBtn.textContent = 'Select';
    if (type === 'inventory') {
        selectBtn.onclick = () => handleSelectInventoryItemForUpgrade(itemData.id);
    } else { // desired
        selectBtn.onclick = () => handleSelectDesiredItemForUpgrade(itemData.name);
    }
    actionsEl.appendChild(selectBtn);

    card.appendChild(imgCont);
    card.appendChild(nameEl);
    card.appendChild(valueEl);
    card.appendChild(actionsEl);
    return card;
}

function updateSlotDisplay(slotElement, itemData, type) { // type 'inventory' or 'desired'
    const placeholder = slotElement.querySelector('.slot-placeholder');
    const display = slotElement.querySelector('.slot-item-display');
    if (itemData) {
        display.querySelector('img').src = itemData.imageFilename || generateImageFilename(itemData.name);
        display.querySelector('img').alt = itemData.name;
        display.querySelector('.slot-item-name').textContent = itemData.name;
        display.querySelector('.slot-item-value').textContent = `${(type === 'inventory' ? itemData.currentValue : itemData.floorPrice).toFixed(2)} TON`;
        placeholder.style.display = 'none';
        display.style.display = 'flex';
        display.style.flexDirection = 'column'; // Ensure items stack vertically
    } else { // Reset slot
        placeholder.style.display = 'flex';
        display.style.display = 'none';
    }
}

function handleSelectInventoryItemForUpgrade(inventoryItemId) {
    const item = currentUser.inventory.find(i => i.id === inventoryItemId);
    if (item) {
        selectedItemForUpgrade = { ...item }; // Store a copy
        updateSlotDisplay(upgradePageElements.selectedInventoryItemSlot, selectedItemForUpgrade, 'inventory');
        
        // Reset desired item if new inventory item is selected
        desiredItemForUpgrade = null;
        updateSlotDisplay(upgradePageElements.desiredUpgradeItemSlot, null, 'desired');
        
        calculateAndDisplayUpgradeStats();
        closeUpgradeItemPicker();
    }
}

function handleSelectDesiredItemForUpgrade(itemName) {
    const item = allAppGiftsForUpgrade.find(g => g.name === itemName);
    if (item) {
        desiredItemForUpgrade = { ...item }; // Store a copy
        updateSlotDisplay(upgradePageElements.desiredUpgradeItemSlot, desiredItemForUpgrade, 'desired');
        calculateAndDisplayUpgradeStats();
        closeUpgradeItemPicker();
    }
}

function calculateAndDisplayUpgradeStats() {
    if (selectedItemForUpgrade && desiredItemForUpgrade) {
        if (selectedItemForUpgrade.currentValue <= 0) {
            calculatedUpgradeMultiplier = 0;
            calculatedUpgradeChance = 0;
            showTGNotification("Selected item has no value.", "error");
        } else {
            calculatedUpgradeMultiplier = desiredItemForUpgrade.floorPrice / selectedItemForUpgrade.currentValue;
            // New chance formula: Chance = MaxChance * Math.pow(RiskFactor, X - 1)
            // Clamp X for chance calculation to avoid extreme values if desired item is much cheaper (though filter should prevent this)
            const xEffective = Math.max(1.01, calculatedUpgradeMultiplier); // Ensure X > 1 for pow calculation
            const maxChance = 75;  // Max possible chance in %
            const minChance = 3;   // Min possible chance in %
            const riskFactor = 0.60; // Lower value means chance drops faster with higher X

            let chance = maxChance * Math.pow(riskFactor, xEffective - 1);
            calculatedUpgradeChance = Math.min(maxChance, Math.max(minChance, chance));
        }

        upgradePageElements.calculatedMultiplierText.textContent = `${calculatedUpgradeMultiplier.toFixed(2)}x`;
        upgradePageElements.calculatedChanceText.textContent = `${calculatedUpgradeChance.toFixed(1)}% Chance`;
        upgradePageElements.doUpgradeButton.disabled = false;
        upgradePageElements.doUpgradeButton.textContent = "Attempt Upgrade";

        // Update the win segment angle for the circle
        const winAngle = (calculatedUpgradeChance / 100) * 360;
        document.documentElement.style.setProperty('--upgrade-win-segment-angle', `${winAngle}deg`);

    } else {
        calculatedUpgradeMultiplier = 0;
        calculatedUpgradeChance = 0;
        upgradePageElements.calculatedMultiplierText.textContent = "--x";
        upgradePageElements.calculatedChanceText.textContent = "--% Chance";
        upgradePageElements.doUpgradeButton.disabled = true;
        upgradePageElements.doUpgradeButton.textContent = "Select Items to Upgrade";
        document.documentElement.style.setProperty('--upgrade-win-segment-angle', `0deg`);
    }
    // Reset pointer
    upgradePageElements.chancePointer.classList.remove('spinning');
    upgradePageElements.chancePointer.style.transform = `translateX(-50%) rotate(0deg)`;

}
// --- END NEW: Functions for New Upgrade UI Logic ---

// --- NEW: Upgrade Animation and Result Modal Functions ---
let upgradeSpinTimeout;

function startUpgradeAnimation(isSuccess) {
    const pointer = upgradePageElements.chancePointer;
    pointer.classList.remove('spinning'); // Remove to reset transition if any
    pointer.style.transform = `translateX(-50%) rotate(0deg)`; // Reset to top
    void pointer.offsetWidth; // Force reflow to apply reset

    const winSegmentAngle = (calculatedUpgradeChance / 100) * 360; // Angle for the green part
    const safetyMargin = 5; // Degrees, to ensure it lands visibly within the segment

    let targetAngle;
    if (isSuccess) {
        // Land somewhere in the middle of the green win segment
        targetAngle = Math.random() * (winSegmentAngle - 2 * safetyMargin) + safetyMargin;
    } else {
        // Land somewhere in the red lose segment
        const loseSegmentStart = winSegmentAngle;
        const loseSegmentAngle = 360 - winSegmentAngle;
        targetAngle = loseSegmentStart + (Math.random() * (loseSegmentAngle - 2 * safetyMargin) + safetyMargin);
    }

    const fullSpins = 3 + Math.floor(Math.random() * 3); // 3 to 5 full spins
    const finalAngle = fullSpins * 360 + targetAngle;

    pointer.classList.add('spinning');
    pointer.style.transform = `translateX(-50%) rotate(${finalAngle}deg)`;
    
    return new Promise(resolve => {
        if(upgradeSpinTimeout) clearTimeout(upgradeSpinTimeout);
        upgradeSpinTimeout = setTimeout(resolve, 5100); // Match CSS transition duration + buffer
    });
}

function showUpgradeResultModal(isSuccess, originalItem, newItemData) { // newItemData is null if failed
    const modal = upgradePageElements.upgradeResultModal;
    const titleEl = upgradePageElements.upgradeResultTitle;
    const messageEl = upgradePageElements.upgradeResultMessage;
    const imageContainer = upgradePageElements.upgradeResultImageContainer;
    imageContainer.innerHTML = ''; // Clear previous images

    if (isSuccess && newItemData) {
        titleEl.textContent = "Upgrade Successful!";
        titleEl.style.color = 'var(--success-color)';
        messageEl.textContent = `Your ${originalItem.name} has been upgraded to ${newItemData.name}!`;
        
        const img = document.createElement('img');
        img.src = newItemData.imageFilename || generateImageFilename(newItemData.name);
        img.alt = newItemData.name;
        imageContainer.appendChild(img);

    } else {
        titleEl.textContent = "Upgrade Failed";
        titleEl.style.color = 'var(--danger-color)';
        messageEl.textContent = `Unfortunately, your ${originalItem.name} was lost in the attempt.`;

        const img = document.createElement('img');
        img.src = originalItem.imageFilename || generateImageFilename(originalItem.name);
        img.alt = originalItem.name;
        imageContainer.appendChild(img); // Show the lost item
    }
    modal.classList.add('active');
    Telegram.WebApp.HapticFeedback?.notificationOccurred(isSuccess ? 'success' : 'error');
}

function closeUpgradeResultModal() {
    upgradePageElements.upgradeResultModal.classList.remove('active');
    // Reset upgrade selections and UI for next attempt
    selectedItemForUpgrade = null;
    desiredItemForUpgrade = null;
    updateSlotDisplay(upgradePageElements.selectedInventoryItemSlot, null, 'inventory');
    updateSlotDisplay(upgradePageElements.desiredUpgradeItemSlot, null, 'desired');
    calculateAndDisplayUpgradeStats();
}

// Event Listeners
upgradePageElements.selectedInventoryItemSlot.addEventListener('click', () => openUpgradeItemPicker('inventory'));
upgradePageElements.desiredUpgradeItemSlot.addEventListener('click', () => openUpgradeItemPicker('desired'));
upgradePageElements.closeUpgradePickerButton.addEventListener('click', closeUpgradeItemPicker);

upgradePageElements.doUpgradeButton.addEventListener('click', handleUpgrade); // Uses the modified handleUpgrade

// Listener for new result modal close button
upgradePageElements.closeUpgradeResultModalButton.addEventListener('click', closeUpgradeResultModal);
    
appNavButtons.forEach(b => b.addEventListener('click', () => navigateToPage(b.dataset.page)));
spinButton.addEventListener('click', spinRoulette);
closeRouletteButton.addEventListener('click', closeRouletteModal);
winOverlaySaveBtn.addEventListener('click', closeWinOverlayModal);
winOverlayConvertBtn.addEventListener('click', handleConvertAll);
caseMultiplierSelector.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', e => {
        selectedCaseMultiplier = parseInt(e.target.dataset.multiplier);
        updateCaseMultiplierButtons();
        updateSpinButtonText();
    });
});
profileElements.disconnectWalletButton.addEventListener('click', () => tonConnectUI.disconnect());
profileElements.initiateDepositButton.addEventListener('click', initiateDepositProcedure);
profileElements.redeemPromocodeButton.addEventListener('click', redeemPromocode);
withdrawStep1NextBtn.addEventListener('click', () => showWithdrawStep(2));
closeWithdrawModalButton?.addEventListener('click', closeWithdrawModal);

inviteElements.copyRefLinkButton.addEventListener('click', () => {
    navigator.clipboard.writeText(inviteElements.referralLink.value).then(() => showTGNotification("Copied!", 'success')).catch(() => showTGNotification("Failed.", 'error'));
});
inviteElements.withdrawReferralButton.addEventListener('click', async () => {
    try {
        const res = await apiRequest('/api/withdraw_referral_earnings', 'POST');
        if (res.status === 'success') {
            currentUser.tonBalance = res.new_balance_ton;
            currentUser.referralEarningsPending = res.new_referral_earnings_pending;
            updateBalances();
            renderInvitePage();
            showTGNotification(res.message, 'success');
        } else showTGNotification(res.message || "Failed.", "error");
    } catch (e) {
        showTGNotification("Withdrawal request failed.", "error");
    }
});
profileElements.sellAllButton?.addEventListener('click', sellAllItems);
confirmPaymentSentButton?.addEventListener('click', verifyPaymentSent);
cancelDepositButton?.addEventListener('click', closeDepositInstructionsModal);

async function fetchInitialUserData() {
    if (!Telegram.WebApp.initData) {
        dataFetchedSuccessfully = true; // No backend data, proceed with local state
        return false;
    }
    try {
        const data = await apiRequest('/api/get_user_data', 'POST', {});
        Object.assign(currentUser, data);
        currentUser.first_name = data.first_name || currentUser.first_name || 'User';
        dataFetchedSuccessfully = true;
        return true;
    } catch (e) {
        showTGNotification("Could not load profile.", 'error');
        dataFetchedSuccessfully = false;
        return false;
    }
}

// --- MODIFIED initializeApp FUNCTION (FULL) ---
async function initializeApp() {
    // Start with a loading status message
    updateLoadingStatus("Initializing application...");

    // Preload images
    const allImageUrls = new Set();
    casesData.forEach(c => {
        const mainImgSrc = c.imageFilename || (c.name ? generateImageFilename(c.name) : null); if (mainImgSrc) allImageUrls.add(mainImgSrc);
        if (c.overlayPrizeName) allImageUrls.add(generateImageFilename(c.overlayPrizeName));
        c.prizes.forEach(p => { if (p.is_ton_prize) allImageUrls.add(TON_COIN_FULL_URL); else allImageUrls.add(generateImageFilename(p.imageFilename || p.name)); });
    });
    allImageUrls.add(TON_COIN_FULL_URL);
    allImageUrls.forEach(url => { const img = new Image(); img.src = url; });

    // Initialize Telegram WebApp BackButton
    if (Telegram.WebApp.BackButton) tgBackButton = Telegram.WebApp.BackButton;

    // Check if running inside Telegram Mini App and get user data
    if (Telegram.WebApp && Telegram.WebApp.initDataUnsafe) {
        updateLoadingStatus("Connecting to Telegram Mini App...");
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        Telegram.WebApp.enableClosingConfirmation();
        
        const tgUser = Telegram.WebApp.initDataUnsafe.user;
        if (tgUser) {
            currentUser.id = tgUser.id;
            currentUser.username = tgUser.username;
            currentUser.first_name = tgUser.first_name || 'User';
            currentUser.last_name = tgUser.last_name;
            currentUser.photo_url = tgUser.photo_url || null; // Store photo_url if available
            
            // Ensure referral code is set for new users, even if not explicitly referred
            if (!currentUser.referralCode) currentUser.referralCode = `ref_${currentUser.id.toString().slice(-6)}`;
        }
        populateAllAppGifts(); 
        // Apply Telegram WebApp colors from CSS variables
        try {
            const bg = getComputedStyle(document.documentElement).getPropertyValue('--bg-gradient-start').trim() || '#181A25';
            Telegram.WebApp.setHeaderColor(bg);
            Telegram.WebApp.setBackgroundColor(bg);
        } catch (e) {
            // Ignore errors if Telegram.WebApp methods are not available or fail
            console.warn("Failed to set Telegram WebApp colors:", e);
        }
    } else {
        // Fallback for non-Telegram environments (e.g., direct browser access)
        console.warn("Not running inside Telegram WebApp. Using fallback data.");
        if (!currentUser.referralCode) currentUser.referralCode = `ref_BRWSR${Math.random().toString(36).substring(2, 8)}`;
        // Provide a placeholder photo_url for browser testing
        currentUser.photo_url = 'https://i.ibb.co/N6dt5Pc9/Background-Eraser-20250423-210102862.png'; 
    }

    // Set up TonConnect UI status change listener
    updateLoadingStatus("Authenticating wallet...");
    tonConnectUI.onStatusChange(async wallet => {
        // This callback can fire before initial user data is fully loaded.
        // updateUIBasedOnWallet handles displaying wallet info.
        updateUIBasedOnWallet(wallet); 
        // If dataFetchedSuccessfully is true, it means main user data is loaded,
        // so we can trigger a re-render of profile/header based on wallet changes.
        if (dataFetchedSuccessfully) {
            renderHeader();
            renderProfile();
        }
    });

    // Fetch initial user data from your backend
    updateLoadingStatus("Loading user data...");
    if (Telegram.WebApp.initData) {
        await fetchInitialUserData(); // This sets dataFetchedSuccessfully based on API response
    } else {
        dataFetchedSuccessfully = true; // No backend data to fetch (e.g., browser mode), so mark as "fetched"
    }
    
    // Ensure UI is updated based on wallet status after initial user data fetch attempt
    // This catches cases where onStatusChange might not have fired yet, or needs a refresh
    updateUIBasedOnWallet(tonConnectWalletInfo || tonConnectUI.wallet);

    // Render main game content and sections
    updateLoadingStatus("Loading game content...");
    renderHeader(); // Renders header (including balance)
    renderCasesAndSlots(); // Renders cases (and slots if you re-add them)
    renderProfile(); // Renders profile page (including inventory and avatar)
    renderLeaderboard(); // Fetches and renders leaderboard data
    renderInvitePage(); // Renders referral page content

    // Navigate to the default main page after everything is loaded
    navigateToPage('main-page');

    // Hide the loading screen after all content is loaded and rendered
    updateLoadingStatus("Ready!");
    if (loadingScreen) {
        loadingScreen.classList.add('hidden');
        // Optional: Remove the element from DOM after transition to be super clean
        // setTimeout(() => { loadingScreen.remove(); }, 600); // 100ms more than the CSS transition duration
    }
}
    
document.addEventListener('DOMContentLoaded', initializeApp);
document.addEventListener('DOMContentLoaded', calculateAndDisplayUpgradeStats);
</script>
</body>
</html>
